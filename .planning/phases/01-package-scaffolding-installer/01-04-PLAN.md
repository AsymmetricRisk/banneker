---
phase: 01-package-scaffolding-installer
plan: 04
type: execute
wave: 3
depends_on: ["03"]
files_modified:
  - test/installer.test.js
autonomous: false

must_haves:
  truths:
    - "npx banneker runs the installer from the local package"
    - "Interactive prompt lets user select runtime"
    - "--claude, --opencode, --gemini flags skip runtime prompt"
    - "--global and --local flags control install location"
    - "--uninstall removes Banneker files without touching others"
    - "Existing install detected via VERSION triggers overwrite prompt"
    - "Zero third-party dependencies in package.json"
  artifacts:
    - path: "test/installer.test.js"
      provides: "Integration tests for installer flow"
      contains: "test.*install"
  key_links:
    - from: "bin/banneker.js"
      to: "lib/installer.js"
      via: "dynamic import"
      pattern: "import.*installer"
    - from: "lib/installer.js"
      to: "lib/flags.js"
      via: "parseFlags import"
      pattern: "import.*parseFlags"
    - from: "lib/installer.js"
      to: "lib/paths.js"
      via: "resolveInstallPaths import"
      pattern: "import.*resolveInstallPaths"
---

<objective>
Write integration tests for the installer and verify the complete end-to-end flow with a human checkpoint.

Purpose: The installer writes to the user's home directory. Before this phase is complete, we need both automated integration tests and human verification that the full flow works correctly.
Output: Integration test file and human-verified working installer.
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-package-scaffolding-installer/01-01-SUMMARY.md
@.planning/phases/01-package-scaffolding-installer/01-02-SUMMARY.md
@.planning/phases/01-package-scaffolding-installer/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write integration tests for installer</name>
  <files>test/installer.test.js</files>
  <action>
Create integration tests using Node.js built-in test runner (`node:test`) that test the installer in a sandboxed temp directory.

Strategy: Use `node:fs` to create a temp directory, set environment or pass homeDir override to test without writing to actual home directory. Import the installer modules directly.

Tests to write:

1. **Non-interactive install to temp dir:**
   - Create temp dir as fake home
   - Call resolveInstallPaths('claude', 'global') with overridden homeDir pointing to temp
   - Manually run the install logic (mkdir, copy templates, write VERSION)
   - Assert: target directory created, VERSION file exists with correct content
   - Assert: stub skill files (banneker-survey.md, banneker-help.md) copied to target

2. **Uninstall from temp dir:**
   - Set up a fake install (write VERSION + stub files to temp dir)
   - Call uninstall() with temp dir paths
   - Assert: VERSION file removed, stub files removed, directory still exists (not deleted)

3. **Overwrite detection:**
   - Write a VERSION file with "0.1.0" to temp dir
   - Verify fs.existsSync detects it
   - Read contents and verify version string

4. **Flag parsing integration:**
   - Verify parseFlags(['--claude', '--global']) returns expected structure
   - Verify parseFlags(['--uninstall', '--claude']) returns uninstall: true

5. **Zero dependencies check:**
   - Read package.json, assert dependencies field is empty or undefined
   - Assert devDependencies is empty or undefined (for now)

Clean up temp directories in afterEach/after hooks using fs.rmSync({ recursive: true }).

Use `import { describe, it, before, after, beforeEach, afterEach } from 'node:test'` and `import assert from 'node:assert/strict'`.
  </action>
  <verify>
`node --test test/installer.test.js` -- all tests pass with 0 failures.
`node --test test/*.test.js` -- full test suite passes.
  </verify>
  <done>Integration tests cover install, uninstall, overwrite detection, stub file copying, and zero-dependency check. All tests pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Banneker installer: package scaffolding, flag parsing, path resolution, interactive prompts, file installation (including stub skill files), uninstallation, and integration tests.</what-built>
  <how-to-verify>
  From the project root (/home/daniel/Documents/banneker):

  1. Run full test suite:
     `node --test test/*.test.js`
     Expected: all tests pass

  2. Test help output:
     `node bin/banneker.js --help`
     Expected: clean usage text with all flags documented

  3. Test non-interactive install for Claude Code:
     `node bin/banneker.js --claude --global`
     Expected: installs to ~/.claude/commands/, prints success message

  4. Verify stub files were installed:
     `ls ~/.claude/commands/banneker-survey.md ~/.claude/commands/banneker-help.md ~/.claude/commands/VERSION`
     Expected: all three files exist

  5. Test overwrite detection:
     `node bin/banneker.js --claude --global`
     Expected: detects existing VERSION, prompts for overwrite. Type 'n' to cancel.

  6. Test uninstall:
     `node bin/banneker.js --uninstall --claude --global`
     Expected: removes Banneker files, prints count

  7. Test error handling:
     `node bin/banneker.js --claude --opencode`
     Expected: error about multiple runtimes

  8. Verify zero dependencies:
     `node -e "const p=JSON.parse(require('fs').readFileSync('package.json','utf8')); console.log('deps:', p.dependencies, 'devDeps:', p.devDependencies)"`
     Expected: both undefined or empty
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- `node --test test/*.test.js` passes with 0 failures
- `node bin/banneker.js --help` shows clean usage
- Non-interactive install/uninstall cycle works
- Stub skill files are copied during install
- Overwrite detection works
- Error messages are clear
- No third-party dependencies
</verification>

<success_criteria>
All seven Phase 1 success criteria from ROADMAP.md are met:
1. `npx banneker` runs the installer from a local package
2. Interactive prompt lets user select runtime
3. --claude, --opencode, --gemini flags skip the runtime prompt
4. --global and --local flags control install location
5. --uninstall removes all Banneker files without touching non-Banneker files
6. Existing install detected via VERSION file triggers overwrite prompt
7. Zero third-party dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/01-package-scaffolding-installer/01-04-SUMMARY.md`
</output>
