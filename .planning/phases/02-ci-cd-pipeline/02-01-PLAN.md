---
phase: 02-ci-cd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/unit/flags.test.js
  - test/unit/paths.test.js
  - test/integration/installer.test.js
  - package.json
  - scripts/test-with-thresholds.js
autonomous: true

must_haves:
  truths:
    - "npm test runs all tests and exits with correct code"
    - "npm run test:coverage reports coverage percentages"
    - "npm run test:coverage-strict enforces 100% on installer code paths"
    - "Test files are organized into unit/, integration/, smoke/ directories"
  artifacts:
    - path: "test/unit/flags.test.js"
      provides: "Flag parsing unit tests (moved from test/)"
    - path: "test/unit/paths.test.js"
      provides: "Path resolution unit tests (moved from test/)"
    - path: "test/integration/installer.test.js"
      provides: "Installer integration tests (moved from test/)"
    - path: "scripts/test-with-thresholds.js"
      provides: "Coverage threshold enforcement script"
      contains: "lineCoverage"
    - path: "package.json"
      provides: "npm scripts for test, test:coverage, test:coverage-strict"
      contains: "test:coverage"
  key_links:
    - from: "scripts/test-with-thresholds.js"
      to: "test/**/*.test.js"
      via: "node:test run() API file globs"
      pattern: "run\\("
    - from: "package.json"
      to: "scripts/test-with-thresholds.js"
      via: "npm script"
      pattern: "test:coverage-strict"
---

<objective>
Set up the test infrastructure for CI/CD: reorganize existing tests into a tiered directory structure (unit/integration/smoke), add npm scripts for running tests with various coverage modes, and create the programmatic coverage threshold enforcement script.

Purpose: The CI pipeline needs reliable npm scripts to invoke. Tests must be organized so unit/integration/smoke tiers can be run independently. Coverage thresholds ensure REQ-CICD-004 (100% coverage of installer file-write code paths) is enforced in CI.

Output: Reorganized test directory, working npm scripts, coverage threshold script.
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ci-cd-pipeline/02-RESEARCH.md

@package.json
@test/flags.test.js
@test/paths.test.js
@test/installer.test.js
@lib/installer.js
@lib/flags.js
@lib/paths.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorganize test directory and move existing tests</name>
  <files>
    test/unit/flags.test.js
    test/unit/paths.test.js
    test/integration/installer.test.js
  </files>
  <action>
    Create the tiered test directory structure:
    - test/unit/
    - test/integration/
    - test/smoke/

    Move existing test files to their proper tiers:
    - test/flags.test.js -> test/unit/flags.test.js
    - test/paths.test.js -> test/unit/paths.test.js
    - test/installer.test.js -> test/integration/installer.test.js

    After moving, update any relative import paths inside the test files. Currently they likely import from '../lib/...' which will need to become '../../lib/...' since they're one directory deeper.

    Delete the original files from test/ root after confirming the moved versions work.

    Verify: Run `node --test test/unit/ test/integration/` to confirm all moved tests still pass.
  </action>
  <verify>node --test test/unit/ test/integration/ passes with 0 failures</verify>
  <done>All existing tests moved to unit/ and integration/ subdirectories, imports updated, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add npm scripts and create coverage threshold script</name>
  <files>
    package.json
    scripts/test-with-thresholds.js
  </files>
  <action>
    1. Update package.json "scripts" section with:
    ```json
    {
      "test": "node --test test/unit/ test/integration/ test/smoke/",
      "test:unit": "node --test test/unit/",
      "test:integration": "node --test test/integration/",
      "test:smoke": "node --test test/smoke/",
      "test:coverage": "node --test --experimental-test-coverage test/unit/ test/integration/ test/smoke/",
      "test:coverage-strict": "node scripts/test-with-thresholds.js"
    }
    ```

    2. Create scripts/test-with-thresholds.js using the node:test programmatic run() API:
    ```javascript
    import { run } from 'node:test';
    import { spec } from 'node:test/reporters';
    import { pipeline } from 'node:stream/promises';

    const stream = run({
      files: [
        'test/unit/',
        'test/integration/',
        'test/smoke/'
      ],
      coverage: true,
      lineCoverage: 100,
      branchCoverage: 100,
      functionCoverage: 100,
      coverageIncludeGlobs: [
        'lib/installer.js',
        'lib/paths.js',
        'lib/flags.js'
      ],
      coverageExcludeGlobs: [
        'test/**/*',
        'scripts/**/*',
        'bin/**/*'
      ],
      concurrency: 1
    });

    await pipeline(stream, new spec(), process.stdout);
    ```

    Note: The run() API accepts directory paths in the files array -- node:test will discover *.test.js files within them. Use `node:test/reporters` for the spec reporter. The script should exit non-zero automatically when coverage thresholds are not met (run() sets process.exitCode).

    Important: Do NOT use glob patterns with `**` in the files array -- pass directory paths and let node:test discover files. If run() does not accept directories in files, use a simple recursive file discovery function to find all *.test.js files in those directories.
  </action>
  <verify>
    npm test passes (runs all tests).
    npm run test:coverage runs and shows coverage output.
    npm run test:coverage-strict runs and either passes with 100% or fails showing which lines lack coverage.
  </verify>
  <done>package.json has all 6 test scripts, scripts/test-with-thresholds.js exists and enforces 100% coverage on installer code paths</done>
</task>

</tasks>

<verification>
1. `npm test` discovers and runs all tests from unit/ and integration/ directories
2. `npm run test:unit` runs only unit tests
3. `npm run test:integration` runs only integration tests
4. `npm run test:coverage` produces coverage report
5. `npm run test:coverage-strict` enforces thresholds on lib/installer.js, lib/paths.js, lib/flags.js
6. No test files remain in test/ root (all in subdirectories)
</verification>

<success_criteria>
- All existing tests pass from their new locations
- 6 npm scripts defined in package.json
- Coverage threshold script enforces 100% line/branch/function coverage on installer code
- Test directory has unit/, integration/, smoke/ subdirectories
</success_criteria>

<output>
After completion, create `.planning/phases/02-ci-cd-pipeline/02-01-SUMMARY.md`
</output>
