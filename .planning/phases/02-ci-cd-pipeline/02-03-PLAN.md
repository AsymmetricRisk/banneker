---
phase: 02-ci-cd-pipeline
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - .github/workflows/validate.yml
  - .github/workflows/publish.yml
autonomous: true

must_haves:
  truths:
    - "Push to any branch triggers validation workflow running full test suite"
    - "PR creation triggers the same validation workflow"
    - "Version tag push triggers publish workflow that runs tests then publishes to npm"
    - "Workflows use minimal permissions (contents: read for validate, +id-token: write for publish)"
  artifacts:
    - path: ".github/workflows/validate.yml"
      provides: "CI validation workflow"
      contains: "node --test"
    - path: ".github/workflows/publish.yml"
      provides: "npm publish workflow triggered by version tags"
      contains: "npm publish"
  key_links:
    - from: ".github/workflows/validate.yml"
      to: "package.json"
      via: "npm ci and npm test"
      pattern: "npm ci"
    - from: ".github/workflows/publish.yml"
      to: "registry.npmjs.org"
      via: "npm publish with OIDC trusted publishing"
      pattern: "registry-url.*registry.npmjs.org"
---

<objective>
Create the two GitHub Actions workflow files: validate.yml (runs on push/PR) and publish.yml (runs on version tags). These are the core CI/CD pipeline artifacts.

Purpose: REQ-CICD-001 requires validation on every push and PR. REQ-CICD-002 requires tag-triggered publishing. The research (02-RESEARCH.md) provides verified workflow patterns to follow.

Output: Two workflow YAML files in .github/workflows/.
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ci-cd-pipeline/02-RESEARCH.md

@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation workflow</name>
  <files>.github/workflows/validate.yml</files>
  <action>
    Create .github/workflows/validate.yml following the pattern from 02-RESEARCH.md "Complete Validation Workflow" section.

    Key specifications:
    - Name: "Validate"
    - Triggers: push to all branches, pull_request to main
    - Top-level permissions: contents: read
    - Matrix strategy: node-version [18.x, 20.x, 22.x], fail-fast: false
    - Steps:
      1. actions/checkout@v4
      2. actions/setup-node@v4 with node-version matrix and cache: 'npm'
      3. npm ci --ignore-scripts
      4. npm test (runs all test tiers via the npm script created in Plan 01)
      5. npm run test:coverage (coverage report, non-blocking -- just for visibility)

    Important details from research:
    - Use `--ignore-scripts` on npm ci to prevent malicious lifecycle scripts
    - Do NOT include smoke tests in the matrix -- they're heavier and included in npm test
    - permissions must be explicitly set (not default)
    - Trigger on push to ALL branches (not just main) per REQ-CICD-001 "every push"
    - Use `push: branches: ['**']` or omit branches filter to trigger on all branches

    Do NOT include publish steps in this workflow. Keep validation and publish separate per research anti-patterns.
  </action>
  <verify>cat .github/workflows/validate.yml shows valid YAML with correct triggers, matrix, and steps</verify>
  <done>validate.yml triggers on push (all branches) and PR (main), runs test suite across Node 18/20/22</done>
</task>

<task type="auto">
  <name>Task 2: Create publish workflow</name>
  <files>.github/workflows/publish.yml</files>
  <action>
    Create .github/workflows/publish.yml following the pattern from 02-RESEARCH.md "Complete Publish Workflow" section.

    Key specifications:
    - Name: "Publish to npm"
    - Triggers: push tags matching 'v*.*.*', plus workflow_dispatch for manual testing
    - Top-level permissions: contents: read, id-token: write
    - Single job (no matrix -- publish only needs one Node version)
    - Steps:
      1. actions/checkout@v4
      2. actions/setup-node@v4 with node-version: 24.x and registry-url: 'https://registry.npmjs.org/'
      3. npm ci --ignore-scripts
      4. npm test (full test suite as safety gate before publish)
      5. npm publish --ignore-scripts --access public

    Critical details from research:
    - Node 24.x is REQUIRED for trusted publishing (npm 11.5.1+)
    - registry-url MUST be specified in setup-node or .npmrc won't be created (Pitfall 8)
    - --ignore-scripts on BOTH npm ci AND npm publish (Pitfall 3)
    - id-token: write permission required for OIDC trusted publishing
    - No NPM_TOKEN secret needed -- trusted publishing uses OIDC
    - Do NOT add --provenance flag (automatic with trusted publishing, per research anti-patterns)
    - --access public because banneker is a public package
    - workflow_dispatch allows testing the workflow without creating a tag

    Optional but recommended: Add `environment: npm-production` for environment protection rules. This allows the user to set up manual approval in GitHub settings later. Include it.
  </action>
  <verify>cat .github/workflows/publish.yml shows valid YAML with tag trigger, Node 24.x, registry-url, and npm publish</verify>
  <done>publish.yml triggers on version tags, uses OIDC trusted publishing with Node 24.x, runs tests before publishing</done>
</task>

</tasks>

<verification>
1. .github/workflows/validate.yml exists with push + PR triggers
2. .github/workflows/publish.yml exists with tag trigger + workflow_dispatch
3. validate.yml uses matrix [18.x, 20.x, 22.x] with --ignore-scripts
4. publish.yml uses Node 24.x with registry-url and id-token: write
5. Neither workflow has overly broad permissions
6. Both workflows use actions/checkout@v4 and actions/setup-node@v4
</verification>

<success_criteria>
- validate.yml triggers on all pushes and PRs, runs full test suite across 3 Node versions
- publish.yml triggers on version tags, runs tests then publishes with trusted publishing
- Workflows follow all security best practices from research (minimal permissions, --ignore-scripts)
- No NPM_TOKEN secret referenced anywhere
</success_criteria>

<output>
After completion, create `.planning/phases/02-ci-cd-pipeline/02-03-SUMMARY.md`
</output>
