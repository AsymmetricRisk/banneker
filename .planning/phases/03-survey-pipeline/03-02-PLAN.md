---
phase: 03-survey-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/commands/banneker-survey.md
autonomous: true

must_haves:
  truths:
    - "Survey command skill file spawns banneker-surveyor sub-agent"
    - "Resume detection checks for existing state file before starting"
    - "User is offered choice to resume or start fresh when state exists"
    - "Completion verification checks that output JSON files exist"
  artifacts:
    - path: "templates/commands/banneker-survey.md"
      provides: "Skill command that orchestrates the survey interview"
      contains: "banneker-surveyor"
      min_lines: 40
  key_links:
    - from: "templates/commands/banneker-survey.md"
      to: "templates/agents/banneker-surveyor.md"
      via: "Task tool spawn instruction"
      pattern: "banneker-surveyor"
    - from: "templates/commands/banneker-survey.md"
      to: ".banneker/state/survey-state.md"
      via: "resume detection check"
      pattern: "survey-state\\.md"
---

<objective>
Replace the stub banneker-survey.md command file with the real orchestrator skill that initiates the 6-phase interview.

Purpose: This is the entry point users invoke with `/banneker:survey`. It handles resume detection, spawns the surveyor sub-agent, and verifies output on completion.

Output: Updated templates/commands/banneker-survey.md (replacing existing stub).
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-survey-pipeline/03-RESEARCH.md
@templates/commands/banneker-survey.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement the survey command skill file</name>
  <files>templates/commands/banneker-survey.md</files>
  <action>
Replace the existing stub in `templates/commands/banneker-survey.md` with the real survey orchestrator skill file using Agent Skills format.

**Frontmatter:**
```yaml
---
name: banneker-survey
description: "Conduct a 6-phase structured discovery interview (pitch, actors, walkthroughs, backend, gaps, decision gate) that produces survey.json and architecture-decisions.json. Handles interruption by saving state to .banneker/state/survey-state.md and offers resume on restart."
---
```

**Content -- the orchestrator instructions:**

This file does NOT conduct the interview itself. It orchestrates:

**Step 0: Resume Detection (MANDATORY -- REQ-CONT-002)**

Check for existing state BEFORE doing anything:

1. Check if `.banneker/state/survey-state.md` exists
2. If exists:
   - Read the file
   - Parse the `## Current Phase` section to identify resume point
   - Display: "Found an interrupted survey at Phase [X]: [phase_name]. Last updated: [timestamp]."
   - Ask: "Resume from Phase [X]? (y/N)"
   - If yes: Pass state file content to surveyor with resume context
   - If no: Ask "Start fresh? This will clear previous progress. (y/N)". If yes: delete state file, start fresh. If no: abort.
3. Also check if `.banneker/survey.json` already exists (completed survey)
   - If exists: "A completed survey already exists. Overwrite with new survey? (y/N)"
   - If no: abort

**Step 1: Ensure Directory Structure**

Create `.banneker/state/` directory if it doesn't exist:
```bash
mkdir -p .banneker/state
```

**Step 2: Spawn Surveyor Sub-Agent**

Use the Task tool to spawn the banneker-surveyor agent:
- Task description: "Conduct 6-phase structured discovery interview"
- Pass context: state file content (if resuming) or "Fresh start -- no prior state" (if new)
- The surveyor agent file is at the same level: reference `banneker-surveyor` agent

**Step 3: Verify Completion**

After surveyor returns, verify outputs:
1. Check `.banneker/survey.json` exists and parses as valid JSON
2. Check `.banneker/architecture-decisions.json` exists and parses as valid JSON
3. Verify survey.json has required top-level keys: `survey_metadata`, `project`, `actors`, `walkthroughs`, `backend`, `rubric_coverage`
4. Verify architecture-decisions.json has `decisions` array

On success:
- Display summary: "Survey complete!"
- Show file paths
- Show counts: X actors, Y walkthroughs, Z architecture decisions

On failure:
- Display what's missing
- State file is preserved for debugging/resume
- Suggest: "Run /banneker:survey again to resume"

**Important implementation notes:**
- This skill file runs inside an AI runtime (Claude Code, OpenCode, Gemini). All "code" is instructions the AI follows, not JavaScript it executes.
- The file operations (mkdir, read, write) are done via the AI runtime's tools (Bash, Read, Write).
- Keep the orchestrator lean -- all interview logic lives in the surveyor agent, not here.
- Reference REQ-CONT-001 for state tracking and REQ-CONT-002 for resume detection.
  </action>
  <verify>
Verify the file has proper frontmatter and is no longer a stub:
```bash
head -5 templates/commands/banneker-survey.md
```
Should show `name: banneker-survey` with the full description (not "stub").

Verify resume detection is present:
```bash
grep -c "survey-state.md" templates/commands/banneker-survey.md
```
Should return 3+ references.

Verify surveyor spawn is present:
```bash
grep -c "banneker-surveyor" templates/commands/banneker-survey.md
```
Should return 1+ references.

Verify verification step exists:
```bash
grep -c "survey.json" templates/commands/banneker-survey.md
```
Should return 3+ references.
  </verify>
  <done>banneker-survey.md is a complete orchestrator skill file that: (1) checks for resume state per REQ-CONT-002, (2) offers resume/fresh-start/abort options, (3) spawns banneker-surveyor sub-agent, (4) verifies JSON output files on completion, and (5) provides helpful success/failure messages. No longer a stub.</done>
</task>

</tasks>

<verification>
1. `templates/commands/banneker-survey.md` has valid Agent Skills frontmatter (not stub)
2. Resume detection covers: no state, interrupted state, completed survey
3. Surveyor agent is referenced for spawn
4. Output verification checks both JSON files
5. Error handling preserves state file for retry
</verification>

<success_criteria>
- banneker-survey.md is a complete orchestrator (not a stub)
- Resume detection follows REQ-CONT-002 pattern
- The file is lean -- interview logic delegated to surveyor agent
- All three user scenarios handled: fresh start, resume from interruption, re-run after completion
</success_criteria>

<output>
After completion, create `.planning/phases/03-survey-pipeline/03-02-SUMMARY.md`
</output>
