---
phase: 03-survey-pipeline
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - lib/constants.js
  - lib/installer.js
  - lib/uninstaller.js
  - test/integration/skill-validation.test.js
  - test/smoke/full-install.test.js
autonomous: true

must_haves:
  truths:
    - "Installer copies agents directory alongside commands directory"
    - "BANNEKER_FILES tracks the surveyor agent file"
    - "Template validation tests verify surveyor agent has valid frontmatter"
    - "Existing tests still pass after installer changes"
  artifacts:
    - path: "lib/constants.js"
      provides: "Updated BANNEKER_FILES with agent entries"
      contains: "banneker-surveyor.md"
    - path: "lib/installer.js"
      provides: "Updated installer that copies both commands and agents"
      contains: "agents"
    - path: "lib/uninstaller.js"
      provides: "Updated uninstaller that handles agent file paths"
      contains: "agents"
    - path: "test/integration/skill-validation.test.js"
      provides: "Tests validating agent template frontmatter"
      contains: "banneker-surveyor"
    - path: "test/smoke/full-install.test.js"
      provides: "Smoke test verifying agent file installation"
      contains: "agents"
  key_links:
    - from: "lib/installer.js"
      to: "templates/agents/"
      via: "cpSync for agents directory"
      pattern: "agents"
    - from: "lib/constants.js"
      to: "templates/agents/banneker-surveyor.md"
      via: "BANNEKER_FILES array entry"
      pattern: "banneker-surveyor"
---

<objective>
Update the installer infrastructure to support agent files alongside command files, and add tests for the new templates.

Purpose: The surveyor agent lives in `templates/agents/` which is a new directory the installer doesn't copy yet. Constants need updating to track new files, installer needs to copy agents, and tests need to validate the new templates.

Output: Updated constants, installer, and integration tests.
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@lib/constants.js
@lib/installer.js
@test/integration/skill-validation.test.js
@test/smoke/full-install.test.js
@lib/uninstaller.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update constants, installer, and uninstaller for agents directory</name>
  <files>lib/constants.js, lib/installer.js, lib/uninstaller.js</files>
  <action>
**Update `lib/constants.js`:**

1. Add `banneker-surveyor.md` to the `BANNEKER_FILES` array. Since this file is installed in a different subdirectory (agents vs commands), consider how the uninstaller will find it. Two approaches:
   - Option A: Store as path with subdirectory: `'agents/banneker-surveyor.md'` (requires uninstaller to resolve relative to config dir)
   - Option B: Separate tracking arrays for commands vs agents

Use Option A (simpler) -- store relative paths in BANNEKER_FILES. The existing entries `'banneker-survey.md'` and `'banneker-help.md'` are in the commands directory. Add a comment clarifying the convention:
```javascript
export const BANNEKER_FILES = [
  'VERSION',
  // Command files (installed to {runtime}/commands/)
  'banneker-survey.md',
  'banneker-help.md',
  // Agent files (installed to {runtime}/agents/)
  'agents/banneker-surveyor.md'
];
```

Also add an `AGENT_FILES` constant for the installer to know which agent files to track separately:
```javascript
export const AGENT_FILES = [
  'banneker-surveyor.md'
];
```

**Update `lib/installer.js`:**

The installer currently copies `templates/commands/` to the runtime's commands directory. Add copying of `templates/agents/` to a parallel agents directory.

1. After the existing `cpSync` for commands templates (around line 162), add a similar block for agents:
   - Source: `join(PACKAGE_ROOT, 'templates', 'agents')`
   - Destination: Determine agents directory from runtime config. Currently `RUNTIMES` has `commands` and `config` paths. The agents directory should be a sibling of commands. For Claude Code: `~/.claude/agents/`, for OpenCode: `~/.opencode/agents/`, for Gemini: `~/.gemini/agents/`.
   - Create the agents directory with `mkdirSync({ recursive: true })`
   - Copy with `cpSync(agentsTemplatesDir, agentsDir, { recursive: true, force: true })`
   - Skip `.gitkeep` files same as commands

2. The agents destination path needs to be computed. The cleanest approach: derive it from the runtime config's `config` path + `/agents/`. So for claude: `~/.claude/agents/`.

3. Handle the case where `templates/agents/` might not exist (graceful skip for backwards compatibility):
   ```javascript
   const agentsTemplatesDir = join(PACKAGE_ROOT, 'templates', 'agents');
   if (existsSync(agentsTemplatesDir)) {
     const agentsDir = join(configDir, 'agents');
     mkdirSync(agentsDir, { recursive: true });
     cpSync(agentsTemplatesDir, agentsDir, { recursive: true, force: true, filter: (src) => !src.endsWith('.gitkeep') });
   }
   ```

   Wait -- `configDir` is already resolved by `resolveInstallPaths()`. It returns `{ commandsDir, configDir }`. The `configDir` for claude is `~/.claude/`. So `join(configDir, 'agents')` = `~/.claude/agents/`. This is correct.

4. Update the success message to mention agents if they were copied.

**Update `lib/uninstaller.js`:**

The uninstaller uses BANNEKER_FILES to remove tracked files. Currently it resolves all files relative to `commandsDir`, which won't work for agent files in `configDir/agents/`. Update the uninstall logic:

1. Read `lib/uninstaller.js` to understand the current file resolution pattern
2. For each file in BANNEKER_FILES:
   - If path contains `/` (e.g., `agents/banneker-surveyor.md`): resolve relative to `configDir` (e.g., `join(configDir, 'agents', 'banneker-surveyor.md')`)
   - If path has no `/` and is a `.md` file: resolve relative to `commandsDir` (existing behavior)
   - If path is `VERSION`: resolve relative to `configDir` (existing behavior)
3. After removing agent files, also remove the empty `agents/` directory if it exists: `rmdirSync(join(configDir, 'agents'))` (wrapped in try/catch for ENOTEMPTY/ENOENT)
  </action>
  <verify>
```bash
cd /home/daniel/Documents/banneker && node -e "
import { BANNEKER_FILES } from './lib/constants.js';
console.log('BANNEKER_FILES:', BANNEKER_FILES);
console.log('Has surveyor:', BANNEKER_FILES.includes('agents/banneker-surveyor.md'));
"
```

Run existing tests to ensure nothing broke:
```bash
cd /home/daniel/Documents/banneker && npm test
```
  </verify>
  <done>Constants include banneker-surveyor.md in BANNEKER_FILES. Installer copies agents directory alongside commands. Uninstaller handles agent file paths. All existing tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for agent templates</name>
  <files>test/integration/skill-validation.test.js</files>
  <action>
Update the existing template validation test file to also validate agent templates.

The existing tests validate command templates have proper YAML frontmatter with `name` and `description` fields. Add equivalent tests for agent templates:

1. Add a test that scans `templates/agents/` directory for `.md` files
2. For each agent template, verify:
   - File has YAML frontmatter (starts with `---`, has closing `---`)
   - Frontmatter contains `name` field
   - Frontmatter contains `description` field
   - `name` field is non-empty
   - `description` field is non-empty and is longer than 20 characters (agents should have meaningful descriptions)

3. Add specific test for `banneker-surveyor.md`:
   - Verify it mentions all 6 phases: pitch, actors, walkthroughs, backend, gaps, decision
   - Verify it mentions `survey-state.md` (state management)
   - Verify it mentions `survey.json` (output)
   - Verify it mentions `architecture-decisions.json` (output)

4. Follow the existing test patterns in the file (use `node:test` with `describe`/`it`, same assertion style).

5. Also add a test for the updated `banneker-survey.md` command:
   - Verify it is no longer a stub (doesn't contain "placeholder" or "stub")
   - Verify it mentions `banneker-surveyor` (spawns the agent)
   - Verify it mentions `survey-state.md` (resume detection)
  </action>
  <verify>
```bash
cd /home/daniel/Documents/banneker && npm test
```
All tests should pass, including the new agent template validation tests.
  </verify>
  <done>Integration tests validate: (1) all agent templates have valid frontmatter, (2) surveyor agent references all 6 phases and output files, (3) survey command is no longer a stub and references the surveyor agent. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: End-to-end smoke test for agent file installation</name>
  <files>test/smoke/full-install.test.js</files>
  <action>
Update the existing smoke test to verify agent files are installed alongside command files.

The existing smoke test runs the installer in a temp directory and verifies files exist. Add checks for:

1. After installation, verify the agents directory exists at the expected path (e.g., `{configDir}/agents/`)
2. Verify `banneker-surveyor.md` exists in the agents directory
3. Verify the surveyor file has valid frontmatter (non-empty `name` field)

Follow existing smoke test patterns. The smoke test likely:
- Creates a temp directory
- Runs the installer with flags
- Checks file existence
- Cleans up

Add the agent checks in the same flow, after the existing command file checks.

If the smoke test file doesn't exist yet or has a different structure, adapt accordingly -- read the file first to understand the pattern.
  </action>
  <verify>
```bash
cd /home/daniel/Documents/banneker && node --test test/smoke/
```
Smoke tests pass, including agent file installation verification.
  </verify>
  <done>Smoke test verifies agent files are installed to the correct directory alongside command files. Full test suite passes.</done>
</task>

</tasks>

<verification>
1. `npm test` passes with all existing and new tests
2. `lib/constants.js` includes `agents/banneker-surveyor.md` in BANNEKER_FILES
3. `lib/installer.js` copies both commands and agents directories
4. Template validation tests cover agent files
5. Smoke test verifies agent installation
</verification>

<success_criteria>
- Installer copies agents directory to the correct runtime location
- BANNEKER_FILES tracks agent files for uninstall
- Integration tests validate all new template files
- Smoke test proves end-to-end agent file installation works
- All existing tests continue to pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-survey-pipeline/03-03-SUMMARY.md`
</output>
