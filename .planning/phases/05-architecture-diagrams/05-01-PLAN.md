---
phase: 05-architecture-diagrams
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/agents/banneker-diagrammer.md
autonomous: true

must_haves:
  truths:
    - "Diagrammer agent generates 3 CSS-only diagrams in Wave 1 (executive roadmap, decision map, system map)"
    - "Diagrammer agent generates 1 JS-enhanced wiring diagram in Wave 2"
    - "Each diagram is self-contained HTML with all CSS/JS inlined"
    - "Agent reads survey.json and architecture-decisions.json as data sources"
    - "Agent tracks state in diagrammer-state.md for resume capability"
    - "Agent writes .continue-here.md handoff file if context exhausted after Wave 1"
  artifacts:
    - path: "templates/agents/banneker-diagrammer.md"
      provides: "Sub-agent for HTML diagram generation from survey data"
      contains: "banneker-diagrammer"
  key_links:
    - from: "templates/agents/banneker-diagrammer.md"
      to: ".banneker/survey.json"
      via: "Read tool to load survey data"
      pattern: "survey\\.json"
    - from: "templates/agents/banneker-diagrammer.md"
      to: ".banneker/architecture-decisions.json"
      via: "Read tool to load decisions"
      pattern: "architecture-decisions\\.json"
    - from: "templates/agents/banneker-diagrammer.md"
      to: ".banneker/diagrams/"
      via: "Write tool to output HTML files"
      pattern: "\\.banneker/diagrams/"
    - from: "templates/agents/banneker-diagrammer.md"
      to: ".banneker/state/diagrammer-state.md"
      via: "State file for wave tracking and resume"
      pattern: "diagrammer-state\\.md"
---

<objective>
Create the banneker-diagrammer sub-agent that generates 4 self-contained HTML architecture diagrams from survey data in two waves.

Purpose: This agent is the core diagram generator for Phase 5. It transforms structured survey.json and architecture-decisions.json data into visual HTML diagrams using CSS Grid, Flexbox, and inline SVG for CSS-only diagrams (Wave 1) and vanilla JavaScript for the interactive wiring diagram (Wave 2). It follows the established sub-agent pattern from Phase 4 (banneker-architect, banneker-writer).

Output: `templates/agents/banneker-diagrammer.md` — a complete sub-agent skill file with YAML frontmatter and detailed generation instructions for all 4 diagram types.
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-architecture-diagrams/05-RESEARCH.md
@templates/agents/banneker-architect.md
@templates/agents/banneker-writer.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create banneker-diagrammer sub-agent</name>
  <files>templates/agents/banneker-diagrammer.md</files>
  <action>
Create `templates/agents/banneker-diagrammer.md` following the established sub-agent pattern from banneker-architect.md and banneker-writer.md.

**YAML Frontmatter (match existing agent format):**
```yaml
---
name: banneker-diagrammer
description: "Sub-agent that generates self-contained HTML architecture diagrams from survey data. Produces 4 diagrams in two waves: Wave 1 creates 3 CSS-only diagrams (executive roadmap, decision map, system map), Wave 2 creates 1 JS-enhanced architecture wiring diagram."
---
```

**Agent Structure (follow banneker-architect.md pattern):**

The agent file must contain these sections:

**1. Role Introduction:**
"You are the Banneker Diagrammer. You transform survey data and architecture decisions into self-contained HTML architecture diagrams. You generate diagrams in two waves: Wave 1 produces 3 CSS-only static diagrams, Wave 2 produces 1 JavaScript-enhanced interactive diagram."

**2. Input Files:**
- `.banneker/survey.json` — project metadata, actors, walkthroughs, backend details
- `.banneker/architecture-decisions.json` — DEC-XXX format decision entries
- `.banneker/documents/TECHNICAL-SUMMARY.md` — project overview (optional, for context)
- `.banneker/documents/STACK.md` — technology stack details (optional, for system map enrichment)
- `.banneker/documents/INFRASTRUCTURE-ARCHITECTURE.md` — deployment topology (optional, for wiring diagram)

**3. Output Files:**
- `.banneker/diagrams/executive-roadmap.html` — Wave 1: CSS-only timeline
- `.banneker/diagrams/decision-map.html` — Wave 1: CSS-only decision graph
- `.banneker/diagrams/system-map.html` — Wave 1: CSS-only component topology
- `.banneker/diagrams/architecture-wiring.html` — Wave 2: JS-enhanced interactive wiring
- `.banneker/state/diagrammer-state.md` — generation state for resume
- `.banneker/state/.continue-here.md` — handoff file if context exhausted (REQ-CONT-003)

**4. Step 0: Check for Resume State**
Read `.banneker/state/diagrammer-state.md` if it exists. Parse completed waves and individual diagrams. Decision logic:
- If all 4 diagrams complete: report "All diagrams already generated" and list file paths, exit
- If Wave 1 complete but Wave 2 not started: skip to Wave 2 (Step 4)
- If partially complete within Wave 1: resume from next incomplete diagram
- If no state file: start fresh from Step 1

**5. Step 1: Load and Parse Inputs**
Read survey.json and architecture-decisions.json using Read tool. Parse as JSON. Validate required fields exist:
- survey.json must have `project` field with at least `name`
- architecture-decisions.json must have `decisions` array
If validation fails, display error and abort.

Also attempt to read TECHNICAL-SUMMARY.md, STACK.md, and INFRASTRUCTURE-ARCHITECTURE.md for enrichment. These are optional — if missing, generate diagrams with available data only.

Extract data mappings for each diagram:
- **Executive roadmap:** Extract phases/milestones from survey (look for `walkthroughs`, `project.goals`, requirements coverage)
- **Decision map:** Extract all decisions from architecture-decisions.json, group by domain prefix (DEC-INFRA-*, DEC-STACK-*, etc.)
- **System map:** Extract backend components from `survey.backend.stack`, data stores from `survey.backend.data_stores`, integrations from `survey.backend.integrations`. Fall back gracefully if fields missing.
- **Architecture wiring:** Combine all above data plus infrastructure details for interactive connection diagram

**6. Shared Dark-Theme CSS Variables (CRITICAL — inline in every diagram):**
Provide the full `:root` block that MUST be inlined at the top of every diagram's `<style>` tag. Include all design tokens:

```css
:root {
  --bg: #0f1117;
  --bg-card: #1a1d27;
  --bg-card-alt: #151822;
  --border: #2a2e3d;
  --text: #c9cdd8;
  --text-bright: #e8eaf0;
  --text-dim: #6b7280;
  --accent-blue: #4f8ff7;
  --accent-cyan: #36d6c3;
  --accent-green: #34d399;
  --accent-orange: #f59e0b;
  --accent-red: #ef4444;
  --accent-purple: #a78bfa;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.7;
  margin: 0;
  padding: 2rem;
}
```

Emphasize: every diagram MUST include these CSS custom properties. Without them, diagrams render with browser default colors instead of the Banneker dark theme. This is the most common pitfall (see research Pitfall 1).

**7. Step 2: Wave 1 — Generate CSS-Only Diagrams**

For each of the 3 diagrams below, use the Write tool to create a self-contained HTML file. Each file must be a complete `<!DOCTYPE html>` document with ALL CSS inlined in `<style>` tags. No external `<link>` tags. No `<script>` tags in Wave 1 diagrams.

**7a. Executive Roadmap (`executive-roadmap.html`):**
- Layout: CSS Flexbox horizontal timeline with milestone nodes
- Data source: Project phases derived from survey walkthroughs and goals
- Structure: Header with project name, horizontal scrollable timeline with phase cards
- Each milestone card shows: phase number, phase name, key requirements
- Timeline connector: CSS pseudo-elements (`::before`) creating horizontal line between milestones
- Milestone markers: Circular dots with box-shadow halos using `--accent-blue`
- Cards: `--bg-card` background, `--border` border, rounded corners
- Responsive: `overflow-x: auto` for horizontal scrolling on narrow viewports

**7b. Decision Map (`decision-map.html`):**
- Layout: CSS Grid with `grid-template-columns: repeat(auto-fit, minmax(300px, 1fr))`
- Data source: architecture-decisions.json grouped by domain prefix
- Structure: Header, then grid of domain columns, each containing decision nodes
- Domain columns: `--bg-card-alt` background, domain name header with `--accent-cyan` border-bottom
- Decision nodes: `--bg-card` background, show DEC-XXX ID (in `--accent-blue`), choice text (in `--text-bright`), truncated rationale (in `--text-dim`)
- If no domain prefix parseable, use "General" as fallback domain

**7c. System Map (`system-map.html`):**
- Layout: CSS Grid with 3 columns for component topology
- Data source: survey.backend (stack, data_stores, integrations)
- Structure: Header, grid of component nodes (Backend, API Gateway, Frontend), data layer row spanning full width
- Component nodes: `--bg-card` with `--border`, show component name and technologies
- Data layer: dashed border (`border: 2px dashed var(--border)`), spans `grid-column: 1 / -1`, contains data store cards
- SVG connector overlay: absolute-positioned SVG with arrow markers connecting components
- Arrow marker definition using `<marker>` element with `--accent-cyan` fill
- Graceful degradation: if `survey.backend` missing or empty, show "No backend data available" message instead of broken layout

After generating each diagram, update `.banneker/state/diagrammer-state.md` with completion status.

**8. Step 3: Context Budget Check (REQ-DIAG-004, REQ-CONT-003)**
After Wave 1 completes, assess whether to continue to Wave 2. Use output size heuristic: if total output so far exceeds 30KB of generated HTML content, or if the agent estimates it is running low on context, write the handoff file and exit gracefully.

Handoff file at `.banneker/state/.continue-here.md`:
```markdown
# Banneker Diagrammer — Continue Here

## Status
Wave 1: COMPLETE (3 diagrams generated)
Wave 2: NOT STARTED

## Completed Files
- .banneker/diagrams/executive-roadmap.html
- .banneker/diagrams/decision-map.html
- .banneker/diagrams/system-map.html

## Next Step
Wave 2 generates the architecture wiring diagram (JS-enhanced).
Run `/banneker:roadmap` to resume from Wave 2.

## Resume Instructions
The diagrammer agent will read diagrammer-state.md and skip directly to Wave 2.
```

If context allows, proceed to Wave 2.

**9. Step 4: Wave 2 — Generate JS-Enhanced Wiring Diagram**

**Architecture Wiring Diagram (`architecture-wiring.html`):**
- Layout: Full-page SVG canvas with vanilla JavaScript for interactivity
- Data source: Combined survey data — backend components, integrations, data flows, actors
- ALL JavaScript wrapped in an IIFE: `(function() { ... })();` to prevent global scope pollution (research Pitfall 3)
- Use `const`/`let` only, never `var`
- Scope all DOM queries to diagram container element

Interactive features:
- **Click to highlight:** Clicking a component node highlights it and its connected edges
- **Hover tooltips:** Hovering a component shows technology details in a tooltip div
- **Connection labels:** Each edge shows its connection type (REST, SQL, event bus, etc.)

Component rendering:
- Extract components from survey data (backend services, databases, external APIs, frontend)
- Render as SVG `<rect>` with `<text>` labels inside `<g>` groups
- Position using a simple grid-based layout algorithm (not force-directed — keep it simple)
- Style with Banneker dark theme colors

Connection rendering:
- Draw SVG `<path>` elements between related components
- Use `<marker>` arrowheads for directional flows
- Connection data from survey.backend.integrations or inferred from walkthroughs
- Curved connectors using quadratic Bezier: `Q` command in SVG path

State management:
- After generating, update diagrammer-state.md: Wave 2 complete
- Delete `.banneker/state/.continue-here.md` if it exists (handoff no longer needed)

**10. Step 5: Report Results**
List all generated diagrams with file paths. Report total count. Suggest next step: "Run `/banneker:appendix` to compile the HTML appendix."

**Important constraints to emphasize in the agent file:**
- ZERO external dependencies: No CDN links, no external CSS/JS files, no images. Everything inlined.
- Every `var(--xxx)` reference must have a corresponding `:root` declaration in the same file
- HTML must be valid: proper DOCTYPE, charset, viewport meta tags
- No literal string "undefined" in output — validate data before templating
- SVG coordinates should be calculated from data, not hardcoded pixel values
- Test self-containment: each HTML file must render correctly when opened directly in browser (not via any server)
  </action>
  <verify>
1. File exists: `test -f templates/agents/banneker-diagrammer.md && echo "EXISTS"`
2. Has valid YAML frontmatter: First line is `---`, contains `name: banneker-diagrammer`
3. Contains all 4 diagram type specifications: grep for "executive-roadmap", "decision-map", "system-map", "architecture-wiring"
4. Contains Wave 1 and Wave 2 sections: grep for "Wave 1" and "Wave 2"
5. Contains resume/state tracking: grep for "diagrammer-state.md"
6. Contains handoff file instructions: grep for ".continue-here.md"
7. Contains CSS custom properties block: grep for ":root" and "--bg:"
8. Contains IIFE wrapping instruction: grep for "IIFE" or "Immediately Invoked"
9. References survey.json and architecture-decisions.json as inputs
  </verify>
  <done>
- `templates/agents/banneker-diagrammer.md` exists with valid YAML frontmatter (name: banneker-diagrammer)
- Agent contains complete generation instructions for all 4 diagram types
- Wave 1 (CSS-only: executive roadmap, decision map, system map) and Wave 2 (JS-enhanced: wiring diagram) are clearly separated
- Resume capability via diagrammer-state.md is documented
- Context budget handoff via .continue-here.md is documented (REQ-CONT-003)
- Self-contained HTML constraint emphasized with inline CSS/JS requirement
- Shared dark-theme CSS variables block included for inlining
  </done>
</task>

</tasks>

<verification>
1. `templates/agents/banneker-diagrammer.md` exists and follows established agent file pattern
2. Agent covers all 5 requirements: REQ-DIAG-001 (4 diagrams), REQ-DIAG-002 (2-wave architecture), REQ-DIAG-003 (self-contained HTML), REQ-DIAG-004 (context budget handoff), REQ-CONT-003 (handoff file)
3. Agent file is consistent with banneker-architect.md and banneker-writer.md patterns
</verification>

<success_criteria>
- Diagrammer agent file exists with complete generation instructions for 4 HTML diagram types
- Two-wave architecture clearly documented (Wave 1: 3 CSS-only, Wave 2: 1 JS-enhanced)
- Self-contained HTML constraint enforced (no external dependencies)
- Resume and handoff capabilities documented
</success_criteria>

<output>
After completion, create `.planning/phases/05-architecture-diagrams/05-01-SUMMARY.md`
</output>
