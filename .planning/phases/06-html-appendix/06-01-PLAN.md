---
phase: 06-html-appendix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/agents/banneker-publisher.md
autonomous: true

must_haves:
  truths:
    - "Publisher agent reads survey.json for project metadata (name, pitch, version, type)"
    - "Publisher agent converts markdown documents to HTML using marked.js"
    - "Publisher agent generates index.html landing page with navigation grid linking only to available section pages"
    - "Publisher agent generates individual section pages (overview, requirements, infrastructure, security-legal, planning-library) when source data exists"
    - "Publisher agent handles missing documents gracefully — generates partial appendix with only available sections (REQ-APPENDIX-003)"
    - "Publisher agent uses shared.css external link in all pages (not inlined CSS)"
    - "Publisher agent tracks generation state in publisher-state.md for resume capability"
  artifacts:
    - path: "templates/agents/banneker-publisher.md"
      provides: "Sub-agent that compiles documents and diagrams into HTML appendix pages"
      contains: "banneker-publisher"
  key_links:
    - from: "templates/agents/banneker-publisher.md"
      to: ".banneker/survey.json"
      via: "Read tool to load project metadata"
      pattern: "survey\\.json"
    - from: "templates/agents/banneker-publisher.md"
      to: ".banneker/documents/"
      via: "Read tool to load markdown documents for conversion"
      pattern: "\\.banneker/documents/"
    - from: "templates/agents/banneker-publisher.md"
      to: ".banneker/diagrams/"
      via: "Read tool to detect available diagrams for linking"
      pattern: "\\.banneker/diagrams/"
    - from: "templates/agents/banneker-publisher.md"
      to: ".banneker/appendix/"
      via: "Write tool to output HTML pages and shared.css"
      pattern: "\\.banneker/appendix/"
---

<objective>
Create the banneker-publisher sub-agent that compiles planning documents and architecture diagrams into a self-contained dark-themed HTML appendix.

Purpose: This agent is the core compiler for Phase 6. It reads markdown documents from `.banneker/documents/`, detects available diagrams in `.banneker/diagrams/`, and generates HTML section pages plus an index.html landing page in `.banneker/appendix/`. It follows the established sub-agent pattern from Phase 4 (banneker-architect, banneker-writer) and Phase 5 (banneker-diagrammer).

Output: `templates/agents/banneker-publisher.md` — a complete sub-agent skill file with YAML frontmatter and detailed compilation instructions for all appendix page types.
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-html-appendix/06-RESEARCH.md
@templates/agents/banneker-architect.md
@templates/agents/banneker-diagrammer.md
@.banneker/appendix/shared.css
@.banneker/appendix/index.html
@.banneker/appendix/overview.html
@.banneker/appendix/planning-library.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create banneker-publisher sub-agent</name>
  <files>templates/agents/banneker-publisher.md</files>
  <action>
Create `templates/agents/banneker-publisher.md` following the established sub-agent pattern from banneker-architect.md, banneker-writer.md, and banneker-diagrammer.md.

**YAML Frontmatter (match existing agent format):**
```yaml
---
name: banneker-publisher
description: "Sub-agent that compiles planning documents and architecture diagrams into a self-contained dark-themed HTML appendix. Reads markdown from .banneker/documents/, converts to HTML, generates section pages and index.html landing page in .banneker/appendix/. Handles missing documents gracefully by generating partial appendix."
---
```

**Agent Structure (follow banneker-architect.md and banneker-diagrammer.md patterns):**

The agent file must contain these sections:

**1. Role Introduction:**
"You are the Banneker Publisher. You compile planning documents and architecture diagrams into a self-contained, dark-themed HTML appendix. You read markdown documents from `.banneker/documents/`, convert them to HTML, and generate individual section pages and an index.html landing page in `.banneker/appendix/`. You handle missing content gracefully by generating only the sections for which source data exists."

**2. Input Files:**
- `.banneker/survey.json` — project metadata (name, pitch, version, type) for page headers and footers
- `.banneker/architecture-decisions.json` — DEC-XXX decisions for security-legal page
- `.banneker/documents/TECHNICAL-SUMMARY.md` — source for overview.html
- `.banneker/documents/STACK.md` — source for overview.html enrichment
- `.banneker/documents/INFRASTRUCTURE-ARCHITECTURE.md` — source for infrastructure.html
- `.banneker/documents/DEVELOPER-HANDBOOK.md` — source for planning-library.html enrichment
- `.banneker/diagrams/*.html` — available architecture diagrams for linking from section pages
- `.banneker/appendix/shared.css` — existing dark-theme stylesheet (DO NOT regenerate — use as-is)

**3. Output Files:**
- `.banneker/appendix/index.html` — landing page with navigation grid (always generated)
- `.banneker/appendix/overview.html` — executive overview (requires TECHNICAL-SUMMARY.md)
- `.banneker/appendix/requirements.html` — requirements matrix (uses survey.json, always generated)
- `.banneker/appendix/infrastructure.html` — infrastructure details (requires INFRASTRUCTURE-ARCHITECTURE.md)
- `.banneker/appendix/security-legal.html` — security and legal (uses architecture-decisions.json, always generated)
- `.banneker/appendix/planning-library.html` — full document text with accordions (requires at least 1 document)
- `.banneker/state/publisher-state.md` — generation state for resume

**4. Step 0: Check for Resume State**
Read `.banneker/state/publisher-state.md` if it exists. Parse completed pages. Decision logic:
- If all pages complete: report "Appendix already generated" and list file paths, exit
- If partially complete: resume from next incomplete page
- If no state file: start fresh from Step 1

**5. Step 1: Detect Available Content**

This is CRITICAL for REQ-APPENDIX-003. Before generating anything, detect what source content exists.

Check for markdown documents:
```
.banneker/documents/TECHNICAL-SUMMARY.md
.banneker/documents/STACK.md
.banneker/documents/INFRASTRUCTURE-ARCHITECTURE.md
.banneker/documents/DEVELOPER-HANDBOOK.md
```

Check for HTML diagrams:
```
.banneker/diagrams/executive-roadmap.html
.banneker/diagrams/decision-map.html
.banneker/diagrams/system-map.html
.banneker/diagrams/architecture-wiring.html
```

Build available content inventory. Report what was found and what is missing. Continue with available content only.

Section generation rules (which sections can be generated):
- `overview.html` — requires TECHNICAL-SUMMARY.md (STACK.md optional for enrichment)
- `requirements.html` — always generated (uses survey.json which always exists)
- `infrastructure.html` — requires INFRASTRUCTURE-ARCHITECTURE.md
- `security-legal.html` — always generated (uses architecture-decisions.json which always exists)
- `planning-library.html` — requires at least 1 document in .banneker/documents/
- `index.html` — ALWAYS generated, links only to available section pages

**6. Step 2: Load Project Metadata**

Read `.banneker/survey.json` and extract:
- `project.name` — for page titles and headers
- `project.pitch` or `project.description` — for index page subtitle
- `project.type` — for metadata badges (CLI Tool, Web App, etc.)

Read `.banneker/architecture-decisions.json` for security-legal page content.

**7. Step 3: Generate Section Pages**

For each available section, generate an HTML page using the existing appendix prototype as the template. All pages MUST:
- Reference `shared.css` via `<link rel="stylesheet" href="shared.css">` (NOT inline CSS)
- Include appendix-nav breadcrumb bar with prev/next navigation
- Include header with project name, page title, subtitle, metadata badges
- Include nav-links bar linking to all AVAILABLE pages (not hardcoded full list)
- Include footer with project name, version, generation credit
- Use semantic HTML matching the classes defined in shared.css

**Page templates — study the existing prototype files carefully:**

**7a. overview.html:**
- Read TECHNICAL-SUMMARY.md, convert markdown to HTML
- Wrap in page template with title "Executive Overview"
- If STACK.md exists, append its converted HTML as a second section
- If diagrams exist, add a "Related Diagrams" section linking to executive-roadmap.html and system-map.html

**7b. requirements.html:**
- Extract rubric/requirements data from survey.json
- Generate requirements matrix using utility cards and callout boxes (match existing prototype pattern)
- Always generated — survey.json is always present

**7c. infrastructure.html:**
- Read INFRASTRUCTURE-ARCHITECTURE.md, convert markdown to HTML
- Wrap in page template with title "Infrastructure"
- If diagrams exist, add links to system-map.html and architecture-wiring.html

**7d. security-legal.html:**
- Extract decisions from architecture-decisions.json
- Group decisions by domain prefix (DEC-INFRA-*, DEC-STACK-*, etc.)
- Generate decision cards using utility card CSS classes from shared.css
- Include license information (MIT per DEC-003)
- Always generated — architecture-decisions.json is always present

**7e. planning-library.html:**
- Read ALL available documents from .banneker/documents/
- Convert each to HTML
- Wrap each in an accordion item (expandable section) using accordion CSS from shared.css
- Include inline `<script>` for accordion toggle interaction (IIFE-wrapped)
- Accordion toggle: click header to expand/collapse, only one open at a time

**Markdown-to-HTML conversion approach:**
The agent should read each markdown file content and convert it to HTML. Since marked.js is not available at agent runtime (agents run inside the LLM runtime, not Node.js), the agent must convert markdown to HTML manually using its own knowledge of markdown syntax. This means:
- `# Heading` becomes `<h1>Heading</h1>`
- `**bold**` becomes `<strong>bold</strong>`
- `- list item` becomes `<ul><li>list item</li></ul>`
- Code blocks become `<pre><code>...</code></pre>`
- Tables become `<table>` with proper `<thead>` and `<tbody>`
- Links become `<a>` tags

The agent reads the markdown and writes the HTML directly using the Write tool. No external library is needed at agent runtime.

**8. Step 4: Generate index.html**

Generate AFTER all section pages so only actually-generated pages are linked.

Index page structure (match existing prototype):
- Title: "{project.name} Engineering Appendix"
- Subtitle: project pitch from survey.json
- Metadata: version, date, project type, page count
- "What is this?" callout explaining the appendix
- Navigation grid with cards linking to each AVAILABLE section page
- Each card: number badge, section title, brief description
- Footer with project name and version

The nav grid must ONLY include cards for sections that were actually generated. Do NOT include cards linking to pages that were skipped due to missing content.

**9. Step 5: Update State and Report**

Update `.banneker/state/publisher-state.md` with:
- List of generated pages
- List of skipped pages (and why)
- Timestamp

Report results:
- List all generated pages with file paths
- List any skipped sections with reason (missing source document)
- Suggest opening `index.html` in browser to view
- If partial, suggest running prerequisite commands to generate missing content

**Important constraints to emphasize in the agent file:**
- shared.css is NOT regenerated — it already exists. Use `<link rel="stylesheet" href="shared.css">` in every page.
- Nav-links in each page must reflect only available pages, not a hardcoded list of all possible pages
- Every page must be valid HTML5: DOCTYPE, charset, viewport meta
- No literal string "undefined" in output — validate all data before templating
- Diagram files are linked (as `<a>` tags opening in new tab), NOT embedded via `<iframe>` to avoid JavaScript conflicts
- Accordion JavaScript must be IIFE-wrapped to prevent global scope pollution
  </action>
  <verify>
1. File exists: `test -f templates/agents/banneker-publisher.md && echo "EXISTS"`
2. Has valid YAML frontmatter: First line is `---`, contains `name: banneker-publisher`
3. Contains content detection: grep for "TECHNICAL-SUMMARY.md" and "INFRASTRUCTURE-ARCHITECTURE.md"
4. Contains all page types: grep for "overview.html", "requirements.html", "infrastructure.html", "security-legal.html", "planning-library.html", "index.html"
5. Contains partial generation logic: grep for "partial" or "available" or "missing"
6. Contains shared.css reference: grep for "shared.css"
7. Contains accordion instructions: grep for "accordion"
8. Contains state tracking: grep for "publisher-state.md"
9. References survey.json and architecture-decisions.json as inputs
  </verify>
  <done>
- `templates/agents/banneker-publisher.md` exists with valid YAML frontmatter (name: banneker-publisher)
- Agent contains complete compilation instructions for all 6 page types (index + 5 sections)
- Partial appendix generation logic handles missing documents gracefully (REQ-APPENDIX-003)
- All pages reference shared.css via external link (REQ-APPENDIX-001)
- Index page links only to actually-generated section pages (REQ-APPENDIX-002)
- Accordion pattern documented for planning-library.html
- Resume capability via publisher-state.md documented
- Diagrams linked (not embedded) from relevant section pages
  </done>
</task>

</tasks>

<verification>
1. `templates/agents/banneker-publisher.md` exists and follows established agent file pattern
2. Agent covers all 3 requirements: REQ-APPENDIX-001 (self-contained HTML with shared CSS), REQ-APPENDIX-002 (index.html + section pages), REQ-APPENDIX-003 (partial appendix for missing content)
3. Agent handles REQ-CONT-001 (state tracking) and REQ-CONT-002 (resume detection)
4. Agent file is consistent with banneker-architect.md and banneker-diagrammer.md patterns
</verification>

<success_criteria>
- Publisher agent file exists with complete compilation instructions for appendix pages
- Partial generation logic clearly documented (available content detection, conditional section generation)
- All pages use shared.css external link
- Index page dynamically links to available sections only
- Resume capability documented via state file
</success_criteria>

<output>
After completion, create `.planning/phases/06-html-appendix/06-01-SUMMARY.md`
</output>
