---
phase: 06-html-appendix
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - templates/commands/banneker-appendix.md
autonomous: true

must_haves:
  truths:
    - "/banneker:appendix command checks for survey.json and architecture-decisions.json before proceeding"
    - "Command detects resume conditions from publisher-state.md and existing appendix pages"
    - "Command spawns banneker-publisher agent for actual page compilation"
    - "Command verifies output pages exist after agent completes"
    - "Command reports partial appendix with clear messaging about missing sections"
  artifacts:
    - path: "templates/commands/banneker-appendix.md"
      provides: "Command orchestrator for /banneker:appendix"
      contains: "banneker-appendix"
  key_links:
    - from: "templates/commands/banneker-appendix.md"
      to: "templates/agents/banneker-publisher.md"
      via: "Spawns sub-agent for appendix compilation"
      pattern: "banneker-publisher"
    - from: "templates/commands/banneker-appendix.md"
      to: ".banneker/survey.json"
      via: "Prerequisite check before spawning agent"
      pattern: "survey\\.json"
    - from: "templates/commands/banneker-appendix.md"
      to: ".banneker/state/publisher-state.md"
      via: "Resume detection"
      pattern: "publisher-state"
---

<objective>
Create the banneker-appendix command orchestrator that manages the appendix compilation lifecycle: prerequisite checks, resume detection, agent spawning, and output verification.

Purpose: This command file is the user-facing entry point for `/banneker:appendix`. It follows the established command pattern from banneker-architect.md (Phase 4) and banneker-roadmap.md (Phase 5) — checking prerequisites, detecting resume conditions, spawning the publisher sub-agent, and verifying outputs. The command does NOT generate pages itself; it delegates to banneker-publisher.

Output: `templates/commands/banneker-appendix.md` — a complete command skill file with YAML frontmatter and orchestration logic.
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-html-appendix/06-01-SUMMARY.md
@templates/commands/banneker-architect.md
@templates/commands/banneker-roadmap.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create banneker-appendix command orchestrator</name>
  <files>templates/commands/banneker-appendix.md</files>
  <action>
Create `templates/commands/banneker-appendix.md` following the established command pattern from `templates/commands/banneker-architect.md` and `templates/commands/banneker-roadmap.md`.

**YAML Frontmatter (match existing command format):**
```yaml
---
name: banneker-appendix
description: "Compile planning documents and architecture diagrams into a self-contained dark-themed HTML appendix. Produces index.html landing page and individual section pages in .banneker/appendix/. Handles missing documents gracefully by generating partial appendix with available content only."
---
```

**Command Structure (mirror banneker-architect.md and banneker-roadmap.md exactly):**

**1. Role Introduction:**
"You are the appendix command orchestrator. Your job is to manage the HTML appendix compilation lifecycle: check prerequisites, detect resume conditions, spawn the publisher sub-agent to compile appendix pages, and verify outputs on completion."

**2. Step 0: Prerequisite Check (MANDATORY)**

Check for survey.json (required — provides project metadata for all pages):
```bash
cat .banneker/survey.json 2>/dev/null
```
If missing: Display "No survey data found at .banneker/survey.json" and "Run /banneker:survey first to conduct a discovery interview." Abort.

Check for architecture-decisions.json (required — provides content for security-legal page):
```bash
cat .banneker/architecture-decisions.json 2>/dev/null
```
If missing: Display "No architecture decisions found at .banneker/architecture-decisions.json" and "Run /banneker:survey first -- the decision gate phase creates this file." Abort.

Check for shared.css (required — the design system stylesheet):
```bash
test -f .banneker/appendix/shared.css && echo "shared.css: OK"
```
If missing: Display "No shared.css found at .banneker/appendix/shared.css" and "The appendix requires shared.css for styling. This file should exist from the package installation." Abort.

NOTE: Documents and diagrams are NOT prerequisites. The appendix command should proceed even if `.banneker/documents/` is empty — the publisher agent handles partial generation (REQ-APPENDIX-003). However, display a warning:
- If no documents: "Warning: No documents found in .banneker/documents/. Run /banneker:architect first for a complete appendix."
- If no diagrams: "Warning: No diagrams found in .banneker/diagrams/. Run /banneker:roadmap first for diagram references."

**3. Step 1: Resume Detection (REQ-CONT-002)**

Check for `.banneker/state/publisher-state.md` (interrupted generation):
```bash
cat .banneker/state/publisher-state.md 2>/dev/null
```
If exists: Parse to identify completed/remaining pages. Display status. Prompt resume.
- Yes: Proceed to Step 2 with resume context
- No: Prompt start fresh or abort

Check for existing appendix pages (completed run):
```bash
ls .banneker/appendix/*.html 2>/dev/null
```
If index.html plus section pages exist: Display "Appendix pages already exist." List found pages. Prompt: "Regenerate? (y/N)"
- Yes: Delete existing HTML pages (keep shared.css), delete state file, proceed to Step 2
- No: List existing page file paths and exit

**4. Step 2: Create Output Directory**
```bash
mkdir -p .banneker/appendix
mkdir -p .banneker/state
```

**5. Step 3: Spawn Publisher Agent**
Spawn `banneker-publisher` sub-agent with context:
- Instruct agent to read survey.json and architecture-decisions.json
- Instruct agent to detect available documents and diagrams
- If resuming, pass the state file content so agent knows where to resume
- Instruct agent to generate pages to `.banneker/appendix/`

**6. Step 4: Verify Outputs**
After agent completes, verify the expected pages were created.

Check for index.html (must always exist):
```bash
test -f .banneker/appendix/index.html && echo "index.html: OK"
```

Check for section pages:
```bash
test -f .banneker/appendix/overview.html && echo "overview: OK"
test -f .banneker/appendix/requirements.html && echo "requirements: OK"
test -f .banneker/appendix/infrastructure.html && echo "infrastructure: OK"
test -f .banneker/appendix/security-legal.html && echo "security-legal: OK"
test -f .banneker/appendix/planning-library.html && echo "planning-library: OK"
```

Verification logic:
- Count generated HTML pages (excluding shared.css)
- If index.html missing: Report error — this should always be generated
- If all 6 HTML pages exist: Report full success with file paths and sizes
- If partial (some sections missing): Report partial success, list generated pages, list skipped pages with reason. This is NOT an error — it satisfies REQ-APPENDIX-003.
- Suggest: "Open .banneker/appendix/index.html in a browser to view the appendix"
- If documents were missing: Suggest "Run /banneker:architect to generate planning documents, then re-run /banneker:appendix"
- If diagrams were missing: Suggest "Run /banneker:roadmap to generate architecture diagrams, then re-run /banneker:appendix"

**7. Step 5: Clean Up State (on completion)**
If index.html and at least 2 section pages verified (minimum viable appendix):
- Delete `.banneker/state/publisher-state.md` (no longer needed)
- Display final summary with all generated page file paths
  </action>
  <verify>
1. File exists: `test -f templates/commands/banneker-appendix.md && echo "EXISTS"`
2. Has valid YAML frontmatter: First line is `---`, contains `name: banneker-appendix`
3. Contains prerequisite checks: grep for "survey.json" and "architecture-decisions.json" and "shared.css"
4. Contains resume detection: grep for "publisher-state.md"
5. Contains agent spawning: grep for "banneker-publisher"
6. Contains output verification: grep for "index.html" and "overview.html" and "requirements.html"
7. Contains partial completion handling: grep for "partial" or "missing"
8. Contains recommendation for missing content: grep for "/banneker:architect" and "/banneker:roadmap"
  </verify>
  <done>
- `templates/commands/banneker-appendix.md` exists with valid YAML frontmatter (name: banneker-appendix)
- Command follows established orchestrator pattern from banneker-architect.md and banneker-roadmap.md
- Prerequisite checks for survey.json, architecture-decisions.json, and shared.css
- Resume detection for interrupted generation via publisher-state.md
- Spawns banneker-publisher agent for actual compilation
- Verifies output pages after agent completes
- Handles partial appendix as valid outcome (REQ-APPENDIX-003)
- Provides clear guidance on missing content and next steps
  </done>
</task>

</tasks>

<verification>
1. `templates/commands/banneker-appendix.md` exists and follows established command file pattern
2. Command handles all lifecycle stages: prerequisites, resume, spawn, verify, cleanup
3. Consistent with banneker-architect.md and banneker-roadmap.md command structure
4. Partial appendix treated as valid outcome, not error
</verification>

<success_criteria>
- Command file exists with complete orchestration logic for appendix compilation
- Prerequisite, resume, spawn, verify, and cleanup stages all documented
- Partial completion handled as valid outcome with clear user messaging
- Consistent with Phase 4 and Phase 5 command patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06-html-appendix/06-02-SUMMARY.md`
</output>
