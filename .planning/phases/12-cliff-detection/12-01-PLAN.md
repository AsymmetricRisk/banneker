---
phase: 12-cliff-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - schemas/survey.schema.json
  - templates/config/cliff-detection-signals.md
autonomous: true

must_haves:
  truths:
    - "survey.json can store detected cliff signals with timestamps and context"
    - "Explicit cliff signal list is documented and accessible to surveyor agent"
  artifacts:
    - path: "schemas/survey.schema.json"
      provides: "cliff_signals array schema definition"
      contains: "cliff_signals"
    - path: "templates/config/cliff-detection-signals.md"
      provides: "Reference list of explicit cliff phrases with detection guidance"
      contains: "EXPLICIT_CLIFF_SIGNALS"
  key_links:
    - from: "schemas/survey.schema.json"
      to: "cliff_signals array"
      via: "JSON Schema properties definition"
      pattern: "cliff_signals.*type.*array"
---

<objective>
Extend survey.json schema with cliff_signals array and create configuration reference for explicit cliff signal phrases.

Purpose: Establish data structures for cliff detection logging and provide surveyor agent with canonical signal list.
Output: Extended survey schema + cliff detection config file
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-cliff-detection/12-RESEARCH.md

@schemas/survey.schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend survey.schema.json with cliff_signals array</name>
  <files>schemas/survey.schema.json</files>
  <action>
Add `cliff_signals` as an optional property to the survey schema. The cliff_signals array stores detected uncertainty signals during the survey for audit and debugging purposes.

Schema structure to add at top-level properties (after rubric_coverage):

```json
"cliff_signals": {
  "type": "array",
  "description": "Detected uncertainty signals during survey (optional, populated when cliff detection active)",
  "items": {
    "type": "object",
    "required": ["timestamp", "phase", "user_response", "detected_signal", "confidence"],
    "properties": {
      "timestamp": {
        "type": "string",
        "description": "ISO 8601 timestamp of detection",
        "format": "date-time"
      },
      "phase": {
        "type": "string",
        "description": "Survey phase where signal detected (pitch/actors/walkthroughs/backend/gaps)"
      },
      "question_context": {
        "type": "string",
        "description": "The question being asked when signal detected"
      },
      "user_response": {
        "type": "string",
        "description": "User's full response containing the signal"
      },
      "detected_signal": {
        "type": "string",
        "description": "The specific signal phrase that was detected"
      },
      "confidence": {
        "type": "string",
        "description": "Detection confidence level",
        "enum": ["HIGH", "MEDIUM", "LOW"]
      },
      "mode_switch_offered": {
        "type": "boolean",
        "description": "Whether mode switch was offered after this detection"
      },
      "user_accepted": {
        "type": "boolean",
        "description": "Whether user accepted mode switch (only set if offered)"
      }
    }
  }
}
```

Important:
- DO NOT add cliff_signals to the "required" array - it should be optional
- Place it after rubric_coverage in the properties object
- Maintain proper JSON syntax (no trailing commas, proper nesting)
  </action>
  <verify>
Run: `node -e "JSON.parse(require('fs').readFileSync('schemas/survey.schema.json'))"` - should exit 0 (valid JSON)
Grep: `grep -c "cliff_signals" schemas/survey.schema.json` - should return >= 1
  </verify>
  <done>
cliff_signals array schema added to survey.schema.json with all required fields (timestamp, phase, user_response, detected_signal, confidence) and optional fields (question_context, mode_switch_offered, user_accepted)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cliff-detection-signals.md config reference</name>
  <files>templates/config/cliff-detection-signals.md</files>
  <action>
Create a new config file that documents the explicit cliff signal phrases and detection guidance. This file is referenced by the surveyor agent during signal detection.

Content structure:

```markdown
---
name: cliff-detection-signals
description: "Reference configuration for cliff signal detection during surveys. Defines explicit signal phrases and detection thresholds."
version: "1.0"
---

# Cliff Detection Signals

This document defines the explicit cliff signals that trigger mode switch offers during Banneker surveys.

## Explicit Cliff Signals (HIGH Confidence)

These phrases indicate HIGH confidence that the user has reached a knowledge cliff. A single match triggers a mode switch offer.

```javascript
const EXPLICIT_CLIFF_SIGNALS = [
  "i don't know",
  "i dont know",
  "no idea",
  "i'm not sure",
  "i'm not technical enough",
  "whatever you think",
  "whatever you think is best",
  "you decide",
  "take it from here",
  "i'll defer to you",
  "that's beyond my expertise",
  "beyond my expertise",
  "not my area",
  "out of my depth"
];
```

## Detection Algorithm

1. Normalize user response: `toLowerCase().trim()`
2. Check for exact phrase match using `String.includes()`
3. If match found, log to `cliff_signals` array with confidence: "HIGH"
4. Offer mode switch with two-step confirmation

## Threshold Configuration

| Threshold | Value | Description |
|-----------|-------|-------------|
| Single explicit signal | Trigger | One HIGH confidence match triggers offer |
| Declined offers before suppression | 2 | After 2 declined offers, stop offering for this session |
| Session reset | New survey | Decline counter resets on new survey start |

## Notes

- Phase 12 focuses on explicit signals only (HIGH confidence)
- Implicit signal detection (hedging language, quality drop) deferred to Phase 15
- All detections logged regardless of whether offer is made (audit trail)
- Context handoff document written before engineer mode spawn (see surveyor-context.md)
```
  </action>
  <verify>
File exists: `test -f templates/config/cliff-detection-signals.md && echo "exists"`
Contains signal list: `grep -c "EXPLICIT_CLIFF_SIGNALS" templates/config/cliff-detection-signals.md` - should return >= 1
Contains key phrases: `grep -c "i don't know" templates/config/cliff-detection-signals.md` - should return >= 1
  </verify>
  <done>
cliff-detection-signals.md created with complete explicit signal list, detection algorithm documentation, and threshold configuration
  </done>
</task>

</tasks>

<verification>
1. `node -e "JSON.parse(require('fs').readFileSync('schemas/survey.schema.json'))"` exits cleanly
2. `grep "cliff_signals" schemas/survey.schema.json` shows property definition
3. `test -f templates/config/cliff-detection-signals.md` confirms config file exists
4. `grep "EXPLICIT_CLIFF_SIGNALS" templates/config/cliff-detection-signals.md` shows signal list
</verification>

<success_criteria>
- survey.schema.json extended with cliff_signals array (valid JSON, optional property)
- cliff-detection-signals.md created with explicit signal list and detection guidance
- Both files syntactically valid and contain expected content
</success_criteria>

<output>
After completion, create `.planning/phases/12-cliff-detection/12-01-SUMMARY.md`
</output>
