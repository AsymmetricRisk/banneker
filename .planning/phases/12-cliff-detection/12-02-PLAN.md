---
phase: 12-cliff-detection
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - templates/agents/banneker-surveyor.md
autonomous: true

must_haves:
  truths:
    - "Surveyor detects explicit cliff signals in user responses during question-answer cycles"
    - "Detected signals are logged to survey state immediately"
    - "User receives confirmation prompt before mode switch with three options (switch/continue/skip)"
    - "User can decline mode switch and continue survey without penalty"
  artifacts:
    - path: "templates/agents/banneker-surveyor.md"
      provides: "Cliff detection logic and confirmation flow integrated into surveyor agent"
      contains: "Cliff Detection"
  key_links:
    - from: "templates/agents/banneker-surveyor.md"
      to: "cliff-detection-signals.md"
      via: "Signal list reference"
      pattern: "EXPLICIT_CLIFF_SIGNALS"
    - from: "templates/agents/banneker-surveyor.md"
      to: "survey.json cliff_signals"
      via: "Logging protocol"
      pattern: "cliff_signals.*push"
---

<objective>
Add cliff detection logic and confirmation flow to the banneker-surveyor agent template.

Purpose: Enable surveyor to detect when users reach knowledge limits and offer mode switch with explicit confirmation per CLIFF-01 and CLIFF-02 requirements.
Output: Enhanced surveyor agent with cliff detection and confirmation capabilities
</objective>

<execution_model>
**IMPORTANT: LLM-as-Runtime Architecture**

Banneker uses an LLM-as-Runtime model where agent templates ARE the implementation, not just specifications. The banneker-surveyor.md template is a sub-agent spawned by the banneker:survey orchestrator skill. When Claude (the LLM) executes a survey, it reads and follows the instructions in the template as its runtime behavior.

This means:
- Adding cliff detection protocol to the surveyor template IS how cliff detection gets implemented
- The surveyor agent will follow the documented protocol during conversations
- No additional runtime code is needed - the template instructions ARE the runtime logic
- Command invocation (like `/banneker:engineer`) uses the standard Skill tool mechanism that all Banneker commands use
</execution_model>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-cliff-detection/12-RESEARCH.md
@.planning/phases/12-cliff-detection/12-01-SUMMARY.md

@templates/agents/banneker-surveyor.md
@templates/config/cliff-detection-signals.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cliff signal detection logic to surveyor</name>
  <files>templates/agents/banneker-surveyor.md</files>
  <action>
Add a new section "## Cliff Detection Protocol" after the "## Conversation Style" section (before "## Resume Handling"). This section documents the detection algorithm and logging protocol.

Content to add:

```markdown
## Cliff Detection Protocol

During question-answer cycles, monitor user responses for cliff signals indicating they've reached their knowledge limits.

### Explicit Cliff Signals (CLIFF-01)

Check each user response for explicit cliff phrases. The complete signal list is defined in `templates/config/cliff-detection-signals.md`.

**Detection Algorithm:**

1. Normalize user response: `toLowerCase().trim()`
2. Check for exact phrase match using `String.includes()` against EXPLICIT_CLIFF_SIGNALS
3. If match found, log to state with confidence: "HIGH"
4. Proceed to confirmation flow (see below)

### Detection Timing

Check for cliff signals **after each substantive user response** during Phases 1-5. Do not check:
- Simple confirmations ("yes", "looks good", "correct")
- Navigation responses ("next", "continue", "skip")
- Phase 6 decision confirmations

### Logging Protocol

When a cliff signal is detected, **immediately** log to state:

1. **Update survey-state.md** with cliff detection:
   ```markdown
   ## Cliff Signals Detected

   - [timestamp] Phase [N]: Detected "[signal]" in response to "[question context]"
     - Confidence: HIGH
     - Mode switch offered: [yes/no]
     - User accepted: [yes/no/pending]
   ```

2. **Prepare cliff_signals entry** for survey.json (written on completion):
   ```json
   {
     "timestamp": "2026-02-03T10:30:00Z",
     "phase": "backend",
     "question_context": "What data stores does this project use?",
     "user_response": "I don't know, whatever you think is best",
     "detected_signal": "i don't know",
     "confidence": "HIGH",
     "mode_switch_offered": true,
     "user_accepted": false
   }
   ```

### Decline Tracking

Track declined mode switch offers:

- **Counter:** Increment `declinedOffers` each time user chooses "Continue survey" or "Skip question"
- **Threshold:** After 2 declined offers, suppress future offers for this session
- **Reset:** Counter resets on new survey start

When threshold reached, still log detections but don't offer mode switch:
```markdown
[timestamp] Phase [N]: Detected "[signal]" (logged only - user previously declined 2+ offers)
```
```

**Important implementation notes:**
- Add this BEFORE the "## Resume Handling" section
- Do NOT modify existing sections - this is additive
- Maintain proper markdown heading hierarchy (## for main section, ### for subsections)
- Reference `templates/config/cliff-detection-signals.md` for the signal list - do NOT duplicate the full array inline
  </action>
  <verify>
Grep: `grep -c "Cliff Detection Protocol" templates/agents/banneker-surveyor.md` - should return 1
Grep: `grep -c "cliff-detection-signals.md" templates/agents/banneker-surveyor.md` - should return >= 1
Grep: `grep -c "CLIFF-01" templates/agents/banneker-surveyor.md` - should return >= 1
  </verify>
  <done>
Cliff detection protocol section added to surveyor with signal reference, detection algorithm, timing rules, and logging protocol
  </done>
</task>

<task type="auto">
  <name>Task 2: Add confirmation flow and mode switch offer</name>
  <files>templates/agents/banneker-surveyor.md</files>
  <action>
Add a "### Confirmation Flow (CLIFF-02)" subsection within the Cliff Detection Protocol section, after the "### Decline Tracking" subsection.

Content to add:

```markdown
### Confirmation Flow (CLIFF-02)

When a cliff signal is detected and offer threshold not exceeded, present the user with explicit confirmation before any mode switch. **No silent takeover.**

**Step 1: Acknowledge Detection**

After detecting a cliff signal, respond with:

```
I notice you're uncertain about [topic from question context]. I can switch to engineering mode where I'll:

1. Analyze what we've discussed so far in the survey
2. Identify gaps in the information we've collected
3. Propose technical recommendations based on your requirements
4. Present options for your review and approval

You'll still be in control - all recommendations require your approval before any decisions are made.
```

**Step 2: Present Options**

Offer exactly three options:

```
Would you like to:

1. **Switch to engineering mode now** - I'll generate a diagnosis and recommendations
2. **Continue with the survey** - We can finish collecting information first
3. **Skip this question for now** - We can come back to it later

Please respond with 1, 2, or 3.
```

**Step 3: Handle User Response**

| User Response | Action |
|---------------|--------|
| "1", "switch", "yes, switch", "engineering mode" | Set `user_accepted = true`, write context handoff, invoke engineer via Skill tool |
| "2", "continue", "keep going", "finish survey" | Set `user_accepted = false`, increment `declinedOffers`, continue to next question |
| "3", "skip", "later", "come back" | Set `user_accepted = false`, mark question as deferred, increment `declinedOffers`, continue |
| Other response | Clarify: "Please respond with 1, 2, or 3" and repeat options |

**Step 4: Context Handoff (if accepted)**

Before invoking engineer, write `.banneker/state/surveyor-context.md`:

```markdown
---
generated: [ISO 8601 timestamp]
phase_at_switch: [current phase name]
cliff_trigger: "[user's response that triggered detection]"
---

## User Preferences Observed

[List preferences mentioned during conversation]
- Example: "Prefers managed services over self-hosted"
- Example: "Budget-conscious, mentioned 'limited resources'"

## Implicit Constraints

[Constraints implied but not explicitly stated]
- Example: "Solo developer (used 'I' not 'we')"
- Example: "First production application"

## Topics User Felt Confident About

[Areas where user provided detailed, confident responses]

## Topics User Felt Uncertain About

[Areas where hedging language or cliff signals appeared]

## Recommendations for Engineer Agent

[Guidance for engineer based on conversation context]
- Start with simplest viable approach
- Include cost considerations
- Provide educational context
```

**Step 5: Invoke Engineer**

After writing context handoff, invoke the engineer agent using the standard Skill tool mechanism:

```
Switching to engineering mode...

I'll analyze what we've discussed and generate:
- DIAGNOSIS.md - What we know, what's missing, where gaps exist
- RECOMMENDATION.md - Options analysis with trade-offs
- ENGINEERING-PROPOSAL.md - Concrete decisions for your approval
```

Use the Skill tool to invoke `banneker:engineer`. This is the same mechanism used by all Banneker commands - the surveyor agent calls the Skill tool which spawns the engineer sub-agent with the appropriate context.

### Deferred Questions

Questions skipped via option 3 are tracked in survey-state.md:

```markdown
## Deferred Questions

- Phase 4, Question: "What data stores does this project use?" (deferred [timestamp])
```

At the end of each phase, re-offer deferred questions:

```
Before we move on, you skipped a question earlier:
"What data stores does this project use?"

Would you like to:
1. Answer it now
2. Leave it for engineering mode to recommend
3. Mark as "not applicable"
```
```

**Important implementation notes:**
- This goes INSIDE the "## Cliff Detection Protocol" section, after "### Decline Tracking"
- Maintain proper markdown heading hierarchy (### for subsection)
- Do NOT modify the existing "## Completion Protocol" section
- The Skill tool invocation is the standard Banneker pattern - no custom wiring needed
  </action>
  <verify>
Grep: `grep -c "Confirmation Flow" templates/agents/banneker-surveyor.md` - should return >= 1
Grep: `grep -c "CLIFF-02" templates/agents/banneker-surveyor.md` - should return >= 1
Grep: `grep -c "surveyor-context.md" templates/agents/banneker-surveyor.md` - should return >= 1
Grep: `grep -c "Skill tool" templates/agents/banneker-surveyor.md` - should return >= 1
Grep: `grep -c "Deferred Questions" templates/agents/banneker-surveyor.md` - should return >= 1
  </verify>
  <done>
Confirmation flow added with three-option prompt, response handling table, context handoff template, Skill tool invocation clarification, and deferred questions protocol
  </done>
</task>

</tasks>

<verification>
1. `grep "Cliff Detection Protocol" templates/agents/banneker-surveyor.md` shows section exists
2. `grep "cliff-detection-signals.md" templates/agents/banneker-surveyor.md` shows signal reference
3. `grep "Confirmation Flow" templates/agents/banneker-surveyor.md` shows confirmation section
4. `grep "Skill tool" templates/agents/banneker-surveyor.md` shows invocation mechanism is documented
5. `grep "surveyor-context.md" templates/agents/banneker-surveyor.md` shows context handoff reference
6. `grep "Deferred Questions" templates/agents/banneker-surveyor.md` shows deferral protocol
</verification>

<success_criteria>
- CLIFF-01: Surveyor can detect explicit cliff signals using reference to cliff-detection-signals.md
- CLIFF-02: Mode switch offered only after explicit three-option confirmation
- Decline path: User can continue survey without penalty (option 2 or 3)
- Logging: All detections logged to state immediately, regardless of user choice
- Context handoff: surveyor-context.md written before engineer invocation
- Engineer invocation: Uses standard Skill tool mechanism (documented in Step 5)
</success_criteria>

<output>
After completion, create `.planning/phases/12-cliff-detection/12-02-SUMMARY.md`
</output>
