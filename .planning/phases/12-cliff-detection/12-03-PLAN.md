---
phase: 12-cliff-detection
plan: 03
type: tdd
wave: 3
depends_on: ["12-01", "12-02"]
files_modified:
  - lib/cliff-detection.js
  - test/unit/cliff-detection.test.js
  - test/integration/installer.test.js
autonomous: true

must_haves:
  truths:
    - "Cliff detection function correctly identifies explicit signals in user responses"
    - "Detection returns structured result with signal, confidence, and original response"
    - "Non-matching responses return detected: false"
    - "Case-insensitive matching works (I DON'T KNOW matches i don't know)"
    - "Cliff detection config file installed correctly"
  artifacts:
    - path: "lib/cliff-detection.js"
      provides: "Reusable cliff detection function for testing and future use"
      exports: ["detectExplicitCliff", "EXPLICIT_CLIFF_SIGNALS"]
    - path: "test/unit/cliff-detection.test.js"
      provides: "Unit tests for cliff detection accuracy"
      contains: "detectExplicitCliff"
    - path: "test/integration/installer.test.js"
      provides: "Installation tests for cliff detection config"
      contains: "cliff-detection-signals"
  key_links:
    - from: "test/unit/cliff-detection.test.js"
      to: "lib/cliff-detection.js"
      via: "import statement"
      pattern: "import.*cliff-detection"
---

<objective>
Create testable cliff detection module and comprehensive tests for signal detection accuracy.

Purpose: Ensure cliff detection logic is correct, well-tested, and can be validated independently of the surveyor agent. TDD approach ensures detection accuracy before integration.
Output: Cliff detection module with unit tests + installer integration tests for config file
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-cliff-detection/12-RESEARCH.md
@.planning/phases/12-cliff-detection/12-01-SUMMARY.md
@.planning/phases/12-cliff-detection/12-02-SUMMARY.md

@test/unit/flags.test.js
@test/integration/installer.test.js
@templates/config/cliff-detection-signals.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cliff detection module with TDD</name>
  <files>lib/cliff-detection.js, test/unit/cliff-detection.test.js</files>
  <action>
**RED Phase:** Create test file first with failing tests.

Create `test/unit/cliff-detection.test.js`:

```javascript
/**
 * Tests for lib/cliff-detection.js - Cliff signal detection
 */

import { describe, it } from 'node:test';
import assert from 'node:assert';
import { detectExplicitCliff, EXPLICIT_CLIFF_SIGNALS } from '../../lib/cliff-detection.js';

describe('EXPLICIT_CLIFF_SIGNALS', () => {
  it('contains expected signals', () => {
    assert.ok(EXPLICIT_CLIFF_SIGNALS.includes("i don't know"));
    assert.ok(EXPLICIT_CLIFF_SIGNALS.includes("whatever you think"));
    assert.ok(EXPLICIT_CLIFF_SIGNALS.includes("you decide"));
    assert.ok(EXPLICIT_CLIFF_SIGNALS.includes("take it from here"));
  });

  it('has at least 10 signals', () => {
    assert.ok(EXPLICIT_CLIFF_SIGNALS.length >= 10);
  });
});

describe('detectExplicitCliff', () => {
  it('detects "i don\'t know" signal', () => {
    const result = detectExplicitCliff("I don't know what database to use");
    assert.strictEqual(result.detected, true);
    assert.strictEqual(result.signal, "i don't know");
    assert.strictEqual(result.confidence, "HIGH");
  });

  it('detects "whatever you think" signal', () => {
    const result = detectExplicitCliff("Whatever you think is best for the backend");
    assert.strictEqual(result.detected, true);
    assert.strictEqual(result.signal, "whatever you think");
    assert.strictEqual(result.confidence, "HIGH");
  });

  it('detects "you decide" signal', () => {
    const result = detectExplicitCliff("You decide, I trust your judgment");
    assert.strictEqual(result.detected, true);
    assert.strictEqual(result.signal, "you decide");
    assert.strictEqual(result.confidence, "HIGH");
  });

  it('detects "take it from here" signal', () => {
    const result = detectExplicitCliff("Can you take it from here?");
    assert.strictEqual(result.detected, true);
    assert.strictEqual(result.signal, "take it from here");
    assert.strictEqual(result.confidence, "HIGH");
  });

  it('is case insensitive', () => {
    const result = detectExplicitCliff("I DON'T KNOW about infrastructure");
    assert.strictEqual(result.detected, true);
    assert.strictEqual(result.signal, "i don't know");
  });

  it('handles "i dont know" without apostrophe', () => {
    const result = detectExplicitCliff("I dont know the answer");
    assert.strictEqual(result.detected, true);
    assert.strictEqual(result.signal, "i dont know");
  });

  it('preserves original response', () => {
    const original = "I don't know, maybe PostgreSQL?";
    const result = detectExplicitCliff(original);
    assert.strictEqual(result.originalResponse, original);
  });

  it('returns detected: false for non-matching response', () => {
    const result = detectExplicitCliff("I want to use PostgreSQL for the database");
    assert.strictEqual(result.detected, false);
  });

  it('returns detected: false for simple confirmations', () => {
    const result = detectExplicitCliff("Yes, that looks correct");
    assert.strictEqual(result.detected, false);
  });

  it('returns detected: false for technical answers', () => {
    const result = detectExplicitCliff("We should use Redis for caching and PostgreSQL for persistence");
    assert.strictEqual(result.detected, false);
  });

  it('detects signals embedded in longer responses', () => {
    const result = detectExplicitCliff("For the database question, I don't know, I've never worked with databases before");
    assert.strictEqual(result.detected, true);
    assert.strictEqual(result.signal, "i don't know");
  });

  it('detects "beyond my expertise" signal', () => {
    const result = detectExplicitCliff("That's beyond my expertise, I'm more of a designer");
    assert.strictEqual(result.detected, true);
    assert.strictEqual(result.signal, "beyond my expertise");
  });

  it('detects "i\'m not technical enough" signal', () => {
    const result = detectExplicitCliff("I'm not technical enough to answer that");
    assert.strictEqual(result.detected, true);
    assert.strictEqual(result.signal, "i'm not technical enough");
  });
});
```

**GREEN Phase:** Create implementation to pass tests.

Create `lib/cliff-detection.js`:

```javascript
/**
 * Cliff detection module for Banneker surveys
 * Detects explicit signals indicating user has reached knowledge limits
 */

/**
 * Explicit cliff signal phrases (HIGH confidence)
 * A single match triggers mode switch offer
 */
export const EXPLICIT_CLIFF_SIGNALS = [
  "i don't know",
  "i dont know",
  "no idea",
  "i'm not sure",
  "i'm not technical enough",
  "whatever you think",
  "whatever you think is best",
  "you decide",
  "take it from here",
  "i'll defer to you",
  "that's beyond my expertise",
  "beyond my expertise",
  "not my area",
  "out of my depth"
];

/**
 * Detect explicit cliff signals in user response
 * @param {string} userResponse - User's response text
 * @returns {object} Detection result with detected, signal, confidence, originalResponse
 */
export function detectExplicitCliff(userResponse) {
  const normalized = userResponse.toLowerCase().trim();

  for (const signal of EXPLICIT_CLIFF_SIGNALS) {
    if (normalized.includes(signal)) {
      return {
        detected: true,
        signal: signal,
        confidence: "HIGH",
        originalResponse: userResponse
      };
    }
  }

  return { detected: false };
}
```

Run tests: `npm test -- --test-name-pattern="cliff"`

**REFACTOR Phase:** Review for clarity, no changes expected for this simple module.
  </action>
  <verify>
Run: `npm test -- --test-name-pattern="cliff"` - all tests pass
Run: `npm test` - full suite passes (no regressions)
  </verify>
  <done>
lib/cliff-detection.js created with EXPLICIT_CLIFF_SIGNALS array and detectExplicitCliff function; all unit tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add installer integration tests for cliff detection config</name>
  <files>test/integration/installer.test.js</files>
  <action>
Add new test suite to `test/integration/installer.test.js` for cliff detection config file installation.

Add after the existing "Engineer config installation" test suite:

```javascript
describe('Cliff detection config installation', () => {
  let tempDir;

  beforeEach(() => {
    tempDir = mkdtempSync(join(tmpdir(), 'banneker-test-cliff-'));
  });

  afterEach(() => {
    rmSync(tempDir, { recursive: true, force: true });
  });

  it('copies cliff-detection-signals.md to config directory', () => {
    const sourceDir = join(process.cwd(), 'templates', 'config');
    const destDir = join(tempDir, 'config');

    // Simulate installer copy
    cpSync(sourceDir, destDir, { recursive: true });

    const targetFile = join(destDir, 'cliff-detection-signals.md');
    assert.ok(existsSync(targetFile), 'cliff-detection-signals.md should be copied');
  });

  it('cliff-detection-signals.md contains explicit signal list', () => {
    const sourceFile = join(process.cwd(), 'templates', 'config', 'cliff-detection-signals.md');
    const content = readFileSync(sourceFile, 'utf8');

    assert.ok(content.includes('EXPLICIT_CLIFF_SIGNALS'), 'Should contain signal list constant');
    assert.ok(content.includes("i don't know"), 'Should contain "i don\'t know" signal');
    assert.ok(content.includes("whatever you think"), 'Should contain "whatever you think" signal');
    assert.ok(content.includes("you decide"), 'Should contain "you decide" signal');
  });

  it('cliff-detection-signals.md has valid frontmatter', () => {
    const sourceFile = join(process.cwd(), 'templates', 'config', 'cliff-detection-signals.md');
    const content = readFileSync(sourceFile, 'utf8');

    assert.ok(content.startsWith('---'), 'Should start with frontmatter delimiter');
    assert.ok(content.includes('name: cliff-detection-signals'), 'Should have name in frontmatter');
    assert.ok(content.includes('version:'), 'Should have version in frontmatter');
  });
});
```

Ensure required imports are present at top of file (add if missing):
- `existsSync` from 'node:fs'
- `readFileSync` from 'node:fs'

Run full test suite to verify no regressions.
  </action>
  <verify>
Run: `npm test -- --test-name-pattern="Cliff detection config"` - all tests pass
Run: `npm test` - full suite passes (no regressions)
  </verify>
  <done>
Installer integration tests added for cliff-detection-signals.md: copy verification, content validation, frontmatter check
  </done>
</task>

</tasks>

<verification>
1. `npm test -- --test-name-pattern="cliff"` - cliff detection unit tests pass
2. `npm test -- --test-name-pattern="Cliff detection config"` - installer tests pass
3. `npm test` - full test suite passes with no regressions
4. `node -e "import('./lib/cliff-detection.js').then(m => console.log(m.EXPLICIT_CLIFF_SIGNALS.length))"` - outputs number >= 10
</verification>

<success_criteria>
- lib/cliff-detection.js exports EXPLICIT_CLIFF_SIGNALS and detectExplicitCliff
- Unit tests cover: signal detection, case insensitivity, non-matching responses, embedded signals
- Installer tests verify config file is copied and contains expected content
- Full test suite passes (96+ tests, 0 failures)
</success_criteria>

<output>
After completion, create `.planning/phases/12-cliff-detection/12-03-SUMMARY.md`
</output>
