---
phase: 14-survey-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/agents/banneker-surveyor.md
autonomous: true

must_haves:
  truths:
    - "Cliff detection during survey triggers pending offer at phase boundaries"
    - "User can decline offer and continue survey normally"
    - "Decline tracking persists to state file"
  artifacts:
    - path: "templates/agents/banneker-surveyor.md"
      provides: "Extended cliff tracking state management"
      contains: "## Cliff Tracking State Management"
  key_links:
    - from: "templates/agents/banneker-surveyor.md"
      to: "survey-state.md"
      via: "state persistence for pendingOffer and declinedOffers"
      pattern: "pendingOffer|declinedOffers"
---

<objective>
Extend surveyor agent with state-tracking for mid-survey takeover offers at phase boundaries.

Purpose: Enable cliff detection during survey to accumulate pending offers without immediate interruption, then present confirmation at natural pause points (phase completion).
Output: Updated surveyor agent with cliff tracking state management protocol
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-survey-integration/14-RESEARCH.md

# Phase 12 established cliff detection protocol in surveyor
@templates/agents/banneker-surveyor.md
@lib/cliff-detection.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cliff tracking state management section to surveyor</name>
  <files>templates/agents/banneker-surveyor.md</files>
  <action>
Add a new section "## Cliff Tracking State Management" BEFORE the existing "## Cliff Detection Protocol" section. This section defines the state fields and their persistence:

```markdown
## Cliff Tracking State Management

During survey phases 1-5, track cliff detection state for phase-boundary offers.

### State Fields (persisted to survey-state.md)

Add these fields to the survey-state.md file under a `## Cliff Detection State` section:

- **pendingOffer**: Object with detection result when cliff signal detected, null when cleared
  - Set when: Cliff signal detected in response
  - Clear when: Offer presented at phase boundary (accept, decline, or skip)
- **declinedOffers**: Integer count of declined mode switch offers (default: 0)
  - Increment when: User chooses "Continue survey" (option 2) or "Skip question" (option 3)
  - Reset when: New survey started
  - Threshold: 2 (suppress offers after 2 declines)
- **cliffSignals**: Array of all detected signals (logged regardless of offer status)
  - Entry format: { timestamp, phase, question_context, user_response, detected_signal, confidence, mode_switch_offered, user_accepted }
- **deferredQuestions**: Array of questions skipped via option 3
  - Entry format: { phase, question, deferredAt }

### State File Structure

Update survey-state.md to include cliff tracking:

```markdown
## Cliff Detection State

**Declined offers:** [N]
**Pending offer:** [true/false]
**Suppression threshold:** 2

### Cliff Signals Detected

- [timestamp] Phase [N]: Detected "[signal]" in response to "[question context]"
  - Confidence: HIGH
  - Mode switch offered: [yes/no/pending]
  - User accepted: [yes/no/pending]

### Deferred Questions

- Phase [N], Q: "[question text]" (deferred [timestamp])
```

### State Update Protocol

After each substantive user response in Phases 1-5:

1. Check response for cliff signal using detectExplicitCliff() algorithm
2. If detected:
   a. Create cliff entry with mode_switch_offered: false, user_accepted: null
   b. Append to cliffSignals array
   c. If declinedOffers < 2 AND confidence === "HIGH":
      - Set pendingOffer = { detection, cliffEntry }
3. Write updated state to survey-state.md

At each phase boundary (before moving to next phase):

1. If pendingOffer is not null:
   a. Present three-option confirmation (see Confirmation Flow section)
   b. Update cliff entry: mode_switch_offered = true
   c. Handle user response (accept/continue/skip)
   d. Clear pendingOffer
2. If deferredQuestions has entries for current phase:
   a. Re-offer each deferred question (see Deferred Questions section)
3. Write updated state to survey-state.md
```

Place this section at approximately line 340, just BEFORE the "## Cliff Detection Protocol" section that starts around line 342.
  </action>
  <verify>Read templates/agents/banneker-surveyor.md and confirm:
1. New "## Cliff Tracking State Management" section exists
2. Section defines pendingOffer, declinedOffers, cliffSignals, deferredQuestions fields
3. Section includes state file structure example
4. Section includes state update protocol for response processing and phase boundaries</verify>
  <done>Surveyor has cliff tracking state management documentation with persistence protocol</done>
</task>

<task type="auto">
  <name>Task 2: Integrate phase boundary offer check into phase completion protocol</name>
  <files>templates/agents/banneker-surveyor.md</files>
  <action>
Modify the surveyor's phase completion sections to integrate cliff offer checking. Find each phase (1-5) completion section and add phase boundary cliff check instruction.

After the "**Before proceeding:**" line in each phase (1-5), add the following text:

```markdown
**Cliff detection check:** Before transitioning to next phase, check if pendingOffer is set. If yes, present mode switch confirmation (see Cliff Detection Protocol section). Process user choice before continuing.
```

Add this to:
- Phase 1: Pitch (around line 87, after "Before proceeding: Confirm collected data...")
- Phase 2: Actors (around line 113, after "Before proceeding: Review the actor list...")
- Phase 3: Walkthroughs (around line 147, after "Before proceeding: Review walkthroughs...")
- Phase 4: Backend (around line 170, after "Before proceeding: Review backend overview...")
- Phase 5: Gaps (around line 204, after "Before proceeding: Review gap analysis...")

Do NOT add to Phase 6 (Decision Gate) - cliff detection does not apply to decision confirmations.

Also, update the State Management Protocol section (around line 19-69) to reference cliff tracking:

Find the "**State file structure:**" code block and add to the template:

```markdown
## Cliff Detection State

**Declined offers:** 0
**Pending offer:** false
**Suppression threshold:** 2

### Cliff Signals Detected

(none yet)

### Deferred Questions

(none yet)
```
  </action>
  <verify>Read templates/agents/banneker-surveyor.md and confirm:
1. Each of phases 1-5 has "Cliff detection check" instruction before proceeding
2. Phase 6 does NOT have cliff detection check
3. State file structure template includes "## Cliff Detection State" section</verify>
  <done>Surveyor phase transitions include cliff offer checking at boundaries</done>
</task>

</tasks>

<verification>
1. `grep -c "Cliff detection check:" templates/agents/banneker-surveyor.md` returns 5 (one per phase 1-5)
2. `grep "Cliff Tracking State Management" templates/agents/banneker-surveyor.md` returns match
3. `grep "pendingOffer" templates/agents/banneker-surveyor.md` returns multiple matches
4. `grep "declinedOffers" templates/agents/banneker-surveyor.md` returns multiple matches
</verification>

<success_criteria>
- Surveyor agent has cliff tracking state management section
- State fields documented: pendingOffer, declinedOffers, cliffSignals, deferredQuestions
- State persistence protocol documented for survey-state.md
- Phase 1-5 transitions include cliff offer check instruction
- Phase 6 does not have cliff detection (decision confirmations excluded)
</success_criteria>

<output>
After completion, create `.planning/phases/14-survey-integration/14-01-SUMMARY.md`
</output>
