---
phase: 14-survey-integration
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - templates/agents/banneker-surveyor.md
  - schemas/survey.schema.json
autonomous: true

must_haves:
  truths:
    - "Context handoff document written before engineer invocation"
    - "surveyor_notes field added to survey.json for self-contained handoff"
    - "Partial survey.json written before mode switch"
    - "Engineer receives full context (no information loss during transition)"
  artifacts:
    - path: "templates/agents/banneker-surveyor.md"
      provides: "Mode switch execution protocol with context handoff"
      contains: "## Mode Switch Execution Protocol"
    - path: "schemas/survey.schema.json"
      provides: "surveyor_notes field in schema"
      contains: "surveyor_notes"
  key_links:
    - from: "templates/agents/banneker-surveyor.md"
      to: ".banneker/state/surveyor-context.md"
      via: "context handoff file write"
      pattern: "surveyor-context\\.md"
    - from: "templates/agents/banneker-surveyor.md"
      to: ".banneker/survey.json"
      via: "partial survey write before mode switch"
      pattern: "partial.*survey\\.json|survey\\.json.*status.*partial"
---

<objective>
Implement context handoff protocol and survey persistence for mid-survey mode switches.

Purpose: Ensure engineer receives full conversational context when taking over from surveyor, preventing information loss (ENGINT-04).
Output: Updated surveyor with mode switch execution protocol, schema extension for surveyor_notes
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-survey-integration/14-RESEARCH.md

# Plan 01 adds cliff tracking state management
@.planning/phases/14-survey-integration/14-01-PLAN.md

# Existing surveyor with cliff detection protocol
@templates/agents/banneker-surveyor.md
@schemas/survey.schema.json
@templates/commands/banneker-engineer.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add surveyor_notes field to survey.json schema</name>
  <files>schemas/survey.schema.json</files>
  <action>
Add an optional `surveyor_notes` field to the survey schema. This field captures context from the surveyor for handoff to engineer when mode switch occurs.

In the root properties object, add:

```json
"surveyor_notes": {
  "type": "object",
  "description": "Context summary from surveyor for engineer handoff (populated on mid-survey mode switch)",
  "properties": {
    "generated": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when notes were generated"
    },
    "phase_at_switch": {
      "type": "string",
      "description": "Survey phase name when mode switch occurred"
    },
    "cliff_trigger": {
      "type": "string",
      "description": "User response that triggered the mode switch"
    },
    "survey_completeness_percent": {
      "type": "integer",
      "minimum": 0,
      "maximum": 100,
      "description": "Estimated survey completion percentage at mode switch"
    },
    "preferences_observed": {
      "type": "array",
      "items": { "type": "string" },
      "description": "User preferences noted during conversation"
    },
    "implicit_constraints": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Constraints implied but not explicitly stated"
    },
    "confident_topics": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Topics where user provided confident responses"
    },
    "uncertain_topics": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Topics where user showed uncertainty"
    },
    "deferred_questions": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "phase": { "type": "string" },
          "question": { "type": "string" },
          "deferred_at": { "type": "string", "format": "date-time" }
        },
        "required": ["phase", "question", "deferred_at"]
      },
      "description": "Questions skipped during survey"
    },
    "engineer_guidance": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Recommendations for engineer based on conversation"
    }
  },
  "required": ["generated", "phase_at_switch"]
}
```

Do NOT add surveyor_notes to the "required" array at the root level - it's optional and only present when mode switch occurs.

Also update the survey_metadata properties to include an optional status field:

```json
"status": {
  "type": "string",
  "enum": ["complete", "partial"],
  "description": "Survey completion status (partial indicates mid-survey mode switch)"
}
```
  </action>
  <verify>Read schemas/survey.schema.json and confirm:
1. surveyor_notes property exists with all nested fields
2. surveyor_notes is NOT in root required array
3. survey_metadata has optional status field with enum ["complete", "partial"]</verify>
  <done>Survey schema extended with surveyor_notes for context handoff</done>
</task>

<task type="auto">
  <name>Task 2: Add mode switch execution protocol to surveyor</name>
  <files>templates/agents/banneker-surveyor.md</files>
  <action>
Add a new section "## Mode Switch Execution Protocol" AFTER the existing "## Cliff Detection Protocol" section (which ends around the Skill tool invocation). This section documents the exact steps for executing a mode switch.

Insert this section after the existing Step 5 (Invoke Engineer) content, approximately around line 500:

```markdown
## Mode Switch Execution Protocol

When user accepts mode switch (option 1), execute these steps in exact order:

### Step A: Build Partial Survey Data

Construct survey.json with current state, marking as partial:

```javascript
const partialSurvey = {
  survey_metadata: {
    version: "1.0",
    created: surveyState.started_at,
    runtime: detectRuntime(),
    status: "partial"  // Indicates mid-survey mode switch
  },
  project: surveyState.project || {},
  actors: surveyState.actors || [],
  walkthroughs: surveyState.walkthroughs || [],
  backend: surveyState.backend || { applicable: "unknown" },
  rubric_coverage: {
    covered: computeCoveredCategories(surveyState),
    gaps: computeRemainingGaps(surveyState)
  },
  cliff_signals: surveyState.cliffSignals || [],
  surveyor_notes: null  // Populated in Step C
};
```

### Step B: Compute Survey Completeness

Calculate completeness percentage based on phases completed:

| Phases Complete | Completeness |
|-----------------|--------------|
| Phase 1 only | 15% |
| Phases 1-2 | 35% |
| Phases 1-3 | 55% |
| Phases 1-4 | 75% |
| Phases 1-5 | 90% |
| All 6 phases | 100% |

Adjust percentage based on partial phase completion (e.g., Phase 3 half-done = 45%).

### Step C: Generate Context Handoff

Build surveyor_notes object by analyzing conversation:

1. **Extract preferences**: Scan conversation for explicit preference statements
   - Look for: "I prefer", "I want", "I don't want", "important to me", "priority is"
   - Example: "I don't want to manage infrastructure" -> "Prefers managed services"

2. **Identify implicit constraints**: Infer from language patterns
   - Solo developer indicators: "I" vs "we", "my app" vs "our team"
   - Experience level: Clarifying questions, technical vocabulary usage
   - Budget sensitivity: Mentions of "limited", "small team", "cost"

3. **Categorize confidence areas**: Based on response quality
   - Confident: Detailed answers, specific examples, quick responses
   - Uncertain: Hedging language, vague answers, cliff signals

4. **Compile deferred questions**: From deferredQuestions state array

5. **Generate engineer guidance**: Based on preferences and constraints
   - If prefers simple -> "Start with simplest viable approach"
   - If budget-conscious -> "Include cost considerations"
   - If inexperienced -> "Provide educational context"

```javascript
const surveyorNotes = {
  generated: new Date().toISOString(),
  phase_at_switch: surveyState.currentPhase,
  cliff_trigger: cliffEntry.user_response,
  survey_completeness_percent: computedCompleteness,
  preferences_observed: extractedPreferences,
  implicit_constraints: inferredConstraints,
  confident_topics: confidentAreas,
  uncertain_topics: uncertainAreas,
  deferred_questions: surveyState.deferredQuestions || [],
  engineer_guidance: generatedGuidance
};

partialSurvey.surveyor_notes = surveyorNotes;
```

### Step D: Write Survey JSON

Write partial survey to disk:

```
.banneker/survey.json
```

Verify write succeeded before proceeding.

### Step E: Write Context Handoff File

Write detailed context to `.banneker/state/surveyor-context.md`:

```markdown
---
generated: [ISO 8601]
phase_at_switch: [phase name]
cliff_trigger: "[trigger response]"
survey_completeness: [N]%
---

## User Preferences Observed

During conversation, user indicated:
[list from surveyor_notes.preferences_observed]

## Implicit Constraints

[list from surveyor_notes.implicit_constraints]

## Topics User Felt Confident About

[list from surveyor_notes.confident_topics]

## Topics User Felt Uncertain About

[list from surveyor_notes.uncertain_topics]

## Deferred Questions

[list from surveyor_notes.deferred_questions with phase/question/timestamp]

## Cliff Signals Detected

[list from cliff_signals array]

## Recommendations for Engineer Agent

[list from surveyor_notes.engineer_guidance]
```

### Step F: Update Survey State

Update survey-state.md with mode switch marker:

```markdown
## Mode Switch

- **Switched at:** [ISO 8601 timestamp]
- **Switch phase:** [phase name]
- **Switch reason:** [cliff trigger signal]
- **Survey completeness:** [N]%
```

### Step G: Display Transition Message

Show user what was saved:

```
Switching to engineering mode...

I've saved our conversation progress:
- Survey data: .banneker/survey.json (Phases 1-[N] captured, [X]% complete)
- Context notes: .banneker/state/surveyor-context.md

I'll now analyze what we've discussed and generate:
- DIAGNOSIS.md - What we know, what's missing, where gaps exist
- RECOMMENDATION.md - Options analysis with trade-offs
- ENGINEERING-PROPOSAL.md - Concrete decisions for your approval

All recommendations will require your approval before any decisions are finalized.
```

### Step H: Invoke Engineer

Use Skill tool to invoke banneker:engineer with context:

**Task name:** "Synthesize engineering documents from mid-survey handoff"
**Context to pass:**
- "Mode switch from surveyor at phase [X]"
- "Survey completeness: [N]%"
- "Read .banneker/state/surveyor-context.md FIRST for conversational context"
- "surveyor_notes embedded in survey.json for structured context"

### Minimum Viability Warning

If survey completeness < 55% (Phases 1-3 not complete), display warning before proceeding:

```
WARNING: Survey is only [X]% complete (Phases 1-3 recommended minimum).

Engineer analysis will have reduced accuracy without:
- Project overview (Phase 1)
- Actor definitions (Phase 2)
- Walkthrough examples (Phase 3)

Continue anyway? (y/N)
```

If user declines, return to survey. If user confirms, proceed with mode switch.
```
  </action>
  <verify>Read templates/agents/banneker-surveyor.md and confirm:
1. New "## Mode Switch Execution Protocol" section exists
2. Steps A through H are documented
3. Step C explains surveyor_notes generation
4. Step E documents surveyor-context.md format
5. Minimum viability warning included for <55% completion</verify>
  <done>Surveyor has complete mode switch execution protocol with context handoff</done>
</task>

</tasks>

<verification>
1. `grep "surveyor_notes" schemas/survey.schema.json | wc -l` returns > 0
2. `grep "Mode Switch Execution Protocol" templates/agents/banneker-surveyor.md` returns match
3. `grep "surveyor-context.md" templates/agents/banneker-surveyor.md` returns multiple matches
4. `grep "status.*partial" templates/agents/banneker-surveyor.md` returns match
5. `npm test` passes (schema changes don't break existing tests)
</verification>

<success_criteria>
- Survey schema has surveyor_notes field with all nested properties
- Surveyor has mode switch execution protocol (Steps A-H)
- Context handoff includes both survey.json (surveyor_notes) and surveyor-context.md
- Minimum viability warning triggers for incomplete surveys
- Engineer invocation includes context file reference
</success_criteria>

<output>
After completion, create `.planning/phases/14-survey-integration/14-02-SUMMARY.md`
</output>
