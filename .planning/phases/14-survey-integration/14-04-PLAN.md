---
phase: 14-survey-integration
plan: 04
type: execute
wave: 4
depends_on: ["14-02", "14-03"]
files_modified:
  - templates/agents/banneker-engineer.md
  - test/integration/surveyor-integration.test.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Engineer agent checks for .banneker/state/surveyor-context.md and reads it first"
    - "Engineer agent parses surveyor_notes from survey.json if present"
    - "Engineer agent checks survey_metadata.status for 'partial' indicator"
    - "DIAGNOSIS.md generation incorporates surveyor_notes context"
  artifacts:
    - path: "templates/agents/banneker-engineer.md"
      provides: "Handoff context consumption in Step 1"
      contains: "surveyor-context.md"
    - path: "templates/agents/banneker-engineer.md"
      provides: "surveyor_notes parsing"
      contains: "surveyor_notes"
    - path: "test/integration/surveyor-integration.test.js"
      provides: "Integration tests for engineer handoff consumption"
      contains: "Engineer Handoff Consumption"
  key_links:
    - from: "templates/agents/banneker-engineer.md"
      to: ".banneker/state/surveyor-context.md"
      via: "Read file check in Step 1"
      pattern: "surveyor-context\\.md"
    - from: "templates/agents/banneker-engineer.md"
      to: "survey.surveyor_notes"
      via: "Parse from survey.json"
      pattern: "survey\\.surveyor_notes|surveyor_notes"
    - from: "templates/agents/banneker-engineer.md"
      to: "DIAGNOSIS.md"
      via: "Incorporates handoff context in generation"
      pattern: "handoff.*context|Handoff Context"
---

<objective>
Wire engineer agent to consume surveyor handoff context (closing Phase 14 verification gap).

Purpose: Complete the "two sides of the pipe" - surveyor generates handoff artifacts (14-02), engineer must consume them. Without this, context is lost during mid-survey mode switch.
Output: Engineer agent reads surveyor-context.md and surveyor_notes, incorporates into DIAGNOSIS.md
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-survey-integration/14-VERIFICATION.md

# Prior work - surveyor generates handoff context
@.planning/phases/14-survey-integration/14-02-SUMMARY.md

# Engineer agent to modify
@templates/agents/banneker-engineer.md

# Schema for surveyor_notes structure reference
@schemas/survey.schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add handoff context consumption to engineer Step 1</name>
  <files>templates/agents/banneker-engineer.md</files>
  <action>
Modify the engineer agent's "## Step 1: Load and Parse Inputs" section to check for and read surveyor handoff context BEFORE processing survey.json normally.

Find the section "## Step 1: Load and Parse Inputs" (around line 54). AFTER the opening paragraph and BEFORE "**Read survey.json:**", insert a new subsection:

```markdown
### Check for Mid-Survey Handoff Context

Before processing survey.json, check if this is a mid-survey handoff from surveyor:

**Step 1a: Check for surveyor-context.md:**

```javascript
const contextPath = '.banneker/state/surveyor-context.md';
// Use Read tool to check if file exists
// If exists, this is a mid-survey handoff - read it FIRST
```

**If surveyor-context.md exists:**
1. Read the file contents (markdown with frontmatter)
2. Parse frontmatter for: `generated`, `phase_at_switch`, `cliff_trigger`, `survey_completeness`
3. Extract sections: User Preferences, Implicit Constraints, Confident Topics, Uncertain Topics, Engineer Guidance
4. Store this context for use in DIAGNOSIS.md generation

**Step 1b: Check survey_metadata.status:**

After loading survey.json, check for partial status indicator:

```javascript
const isPartialSurvey = survey.survey_metadata?.status === 'partial';
if (isPartialSurvey) {
    // This survey was interrupted by mode switch
    // Expect surveyor_notes to be present
    console.log('Partial survey detected - processing mid-survey handoff');
}
```

**Step 1c: Extract surveyor_notes from survey.json:**

If survey has surveyor_notes field, extract handoff context:

```javascript
const surveyorNotes = survey.surveyor_notes;
if (surveyorNotes) {
    // Store for later use in DIAGNOSIS generation
    const handoffContext = {
        generated: surveyorNotes.generated,
        phase_at_switch: surveyorNotes.phase_at_switch,
        cliff_trigger: surveyorNotes.cliff_trigger,
        completeness: surveyorNotes.survey_completeness_percent,
        preferences: surveyorNotes.preferences_observed || [],
        constraints: surveyorNotes.implicit_constraints || [],
        confident: surveyorNotes.confident_topics || [],
        uncertain: surveyorNotes.uncertain_topics || [],
        deferred: surveyorNotes.deferred_questions || [],
        guidance: surveyorNotes.engineer_guidance || []
    };
}
```

**Handoff Context Priority:**
- If both surveyor-context.md AND surveyor_notes exist: Use both (they contain overlapping but complementary info)
- If only surveyor_notes exists: Use surveyor_notes (structured data)
- If only surveyor-context.md exists: Use surveyor-context.md (rich markdown)
- If neither exists: Normal survey processing (no handoff)
```

This subsection should appear BEFORE the existing "**Read survey.json:**" subsection.
  </action>
  <verify>Read templates/agents/banneker-engineer.md and confirm:
1. New subsection "### Check for Mid-Survey Handoff Context" exists
2. Step 1a checks for surveyor-context.md
3. Step 1b checks survey_metadata.status for 'partial'
4. Step 1c extracts surveyor_notes from survey.json
5. Section appears before "Read survey.json:" subsection</verify>
  <done>Engineer Step 1 checks for and reads handoff context before survey processing</done>
</task>

<task type="auto">
  <name>Task 2: Incorporate handoff context into DIAGNOSIS.md generation</name>
  <files>templates/agents/banneker-engineer.md</files>
  <action>
Modify the "## Step 3: Generate DIAGNOSIS.md" section to incorporate surveyor handoff context when present.

Find the DIAGNOSIS.md document structure section (around line 450-555). Add a new section in the document template AFTER "## Survey Overview" and BEFORE "## What Is Known":

In the document structure template, insert this new section:

```markdown
## Handoff Context (Mid-Survey Mode Switch)

[If handoff context exists from surveyor-context.md or surveyor_notes:]

**Mode Switch Detected:** This engineering analysis follows a mid-survey handoff.

**Switch Details:**
- **Phase at switch:** [phase_at_switch from handoff context]
- **Trigger:** "[cliff_trigger - user's response that triggered switch]"
- **Survey completeness at switch:** [completeness]%

### User Preferences Observed

During survey conversation, the user indicated:
[list from preferences_observed or surveyor-context.md "User Preferences Observed" section]

### Implicit Constraints Detected

Based on conversation patterns, these constraints were inferred:
[list from implicit_constraints or surveyor-context.md "Implicit Constraints" section]

### Confidence Distribution

**User felt confident about:**
[list from confident_topics]

**User felt uncertain about:**
[list from uncertain_topics]

### Deferred Questions

These questions were skipped during survey (potential gaps):
[list from deferred_questions with phase/question]

### Surveyor Recommendations

The surveyor agent recommends:
[list from engineer_guidance]

---

[If no handoff context exists:]
*No mid-survey handoff detected. Processing complete survey.*
```

Also add to the "Generation Guidelines" subsection (around line 560):

```markdown
**Handoff context integration:**
- If handoff context exists, the "Handoff Context" section is MANDATORY in DIAGNOSIS.md
- Uncertain topics from handoff should map to LOW confidence recommendations
- User preferences should influence recommendation direction
- Deferred questions are automatically added to gaps list
- Engineer guidance from surveyor should inform recommendation approach
```
  </action>
  <verify>Read templates/agents/banneker-engineer.md and confirm:
1. New "## Handoff Context (Mid-Survey Mode Switch)" section exists in DIAGNOSIS template
2. Template includes: phase_at_switch, cliff_trigger, completeness, preferences, constraints, confidence distribution, deferred questions, surveyor recommendations
3. Generation Guidelines include handoff context integration rules</verify>
  <done>DIAGNOSIS.md template incorporates handoff context when present</done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for engineer handoff consumption</name>
  <files>test/integration/surveyor-integration.test.js</files>
  <action>
Add a new describe block to surveyor-integration.test.js to test that engineer can consume the handoff context generated by surveyor.

Add this new describe block at the end of the file, before the closing of the main describe('Surveyor Integration'):

```javascript
  describe('Engineer Handoff Consumption', () => {
    it('should detect surveyor-context.md presence', async () => {
      // Write surveyor-context.md to temp dir
      const contextPath = join(tempDir, '.banneker', 'state', 'surveyor-context.md');
      const contextContent = `---
generated: 2026-02-03T10:30:00Z
phase_at_switch: backend
cliff_trigger: "I don't know what database to use"
survey_completeness: 55%
---

## User Preferences Observed

- Prefers managed services
- Budget-conscious

## Implicit Constraints

- Solo developer

## Topics User Felt Confident About

- User flows

## Topics User Felt Uncertain About

- Infrastructure

## Recommendations for Engineer Agent

- Start with simple approach
`;
      await writeFile(contextPath, contextContent);

      // Verify file exists (simulating engineer's Step 1a check)
      const content = await readFile(contextPath, 'utf-8');
      assert.ok(content.includes('phase_at_switch: backend'));
      assert.ok(content.includes('Prefers managed services'));
    });

    it('should extract surveyor_notes from partial survey.json', async () => {
      const partialSurvey = {
        survey_metadata: {
          version: '1.0',
          created: '2026-02-03T10:00:00Z',
          runtime: 'claude-code',
          status: 'partial'  // Indicates mid-survey handoff
        },
        project: {
          name: 'TestApp',
          one_liner: 'A test application'
        },
        actors: [{ name: 'User', type: 'human' }],
        walkthroughs: [{ name: 'Test Flow', steps: ['Step 1'] }],
        surveyor_notes: {
          generated: '2026-02-03T10:30:00Z',
          phase_at_switch: 'backend',
          cliff_trigger: "I don't know",
          survey_completeness_percent: 55,
          preferences_observed: ['Prefers managed services'],
          implicit_constraints: ['Solo developer'],
          confident_topics: ['User flows'],
          uncertain_topics: ['Infrastructure', 'Database'],
          deferred_questions: [
            { phase: 'backend', question: 'What caching?', deferred_at: '2026-02-03T10:25:00Z' }
          ],
          engineer_guidance: ['Start simple', 'Include cost analysis']
        }
      };

      const surveyPath = join(tempDir, '.banneker', 'survey.json');
      await writeFile(surveyPath, JSON.stringify(partialSurvey, null, 2));

      // Simulate engineer's Step 1c - extract surveyor_notes
      const content = await readFile(surveyPath, 'utf-8');
      const survey = JSON.parse(content);

      // Verify status check (Step 1b)
      assert.equal(survey.survey_metadata.status, 'partial');

      // Verify surveyor_notes extraction (Step 1c)
      assert.ok(survey.surveyor_notes);
      assert.equal(survey.surveyor_notes.phase_at_switch, 'backend');
      assert.equal(survey.surveyor_notes.survey_completeness_percent, 55);
      assert.deepEqual(survey.surveyor_notes.preferences_observed, ['Prefers managed services']);
      assert.equal(survey.surveyor_notes.deferred_questions.length, 1);
      assert.deepEqual(survey.surveyor_notes.engineer_guidance, ['Start simple', 'Include cost analysis']);
    });

    it('should handle complete survey without handoff context', async () => {
      const completeSurvey = {
        survey_metadata: {
          version: '1.0',
          created: '2026-02-03T10:00:00Z',
          runtime: 'claude-code',
          status: 'complete'  // Normal complete survey
        },
        project: { name: 'TestApp', one_liner: 'A test application' },
        actors: [{ name: 'User', type: 'human' }],
        walkthroughs: [{ name: 'Test Flow', steps: ['Step 1'] }],
        backend: { applicable: true, stack: ['Node.js'] }
        // No surveyor_notes - complete survey
      };

      const surveyPath = join(tempDir, '.banneker', 'survey.json');
      await writeFile(surveyPath, JSON.stringify(completeSurvey, null, 2));

      const content = await readFile(surveyPath, 'utf-8');
      const survey = JSON.parse(content);

      // Verify no handoff context
      assert.equal(survey.survey_metadata.status, 'complete');
      assert.equal(survey.surveyor_notes, undefined);
    });

    it('should map uncertain topics to potential gaps', () => {
      const surveyorNotes = {
        uncertain_topics: ['Infrastructure', 'Database selection', 'Caching strategy'],
        deferred_questions: [
          { phase: 'backend', question: 'What database?', deferred_at: '2026-02-03T10:25:00Z' }
        ]
      };

      // Simulate engineer's gap identification from handoff
      const gapsFromHandoff = [
        ...surveyorNotes.uncertain_topics.map(t => `Uncertainty: ${t}`),
        ...surveyorNotes.deferred_questions.map(q => `Deferred: ${q.question} (${q.phase})`)
      ];

      assert.equal(gapsFromHandoff.length, 4);
      assert.ok(gapsFromHandoff.includes('Uncertainty: Infrastructure'));
      assert.ok(gapsFromHandoff.includes('Deferred: What database? (backend)'));
    });

    it('should prioritize handoff context sources correctly', async () => {
      // Both surveyor-context.md AND surveyor_notes exist
      const contextPath = join(tempDir, '.banneker', 'state', 'surveyor-context.md');
      await writeFile(contextPath, '---\ngenerated: 2026-02-03T10:30:00Z\n---\n\n## User Preferences\n\n- From markdown file');

      const surveyPath = join(tempDir, '.banneker', 'survey.json');
      const survey = {
        survey_metadata: { status: 'partial' },
        project: { name: 'Test' },
        actors: [],
        walkthroughs: [],
        surveyor_notes: {
          generated: '2026-02-03T10:30:00Z',
          phase_at_switch: 'backend',
          preferences_observed: ['From JSON notes']
        }
      };
      await writeFile(surveyPath, JSON.stringify(survey, null, 2));

      // Both sources exist - should use both
      const mdContent = await readFile(contextPath, 'utf-8');
      const jsonContent = JSON.parse(await readFile(surveyPath, 'utf-8'));

      assert.ok(mdContent.includes('From markdown file'));
      assert.ok(jsonContent.surveyor_notes.preferences_observed.includes('From JSON notes'));
    });
  });
```
  </action>
  <verify>Run `npm test -- --test-name-pattern="Engineer Handoff"` and verify:
1. All 5 new tests pass
2. Tests cover: surveyor-context.md detection, surveyor_notes extraction, complete survey handling, uncertain topics mapping, priority handling</verify>
  <done>Integration tests verify engineer can consume handoff context from surveyor</done>
</task>

</tasks>

<verification>
1. `grep "surveyor-context.md" templates/agents/banneker-engineer.md | wc -l` returns >= 2
2. `grep "surveyor_notes" templates/agents/banneker-engineer.md | wc -l` returns >= 3
3. `grep "Handoff Context" templates/agents/banneker-engineer.md` returns match
4. `grep "survey_metadata.status" templates/agents/banneker-engineer.md` returns match (checking for 'partial')
5. `npm test -- --test-name-pattern="Engineer Handoff"` passes all tests
6. `npm test` passes (no regressions)
</verification>

<success_criteria>
- Engineer agent Step 1 checks for .banneker/state/surveyor-context.md
- Engineer agent extracts surveyor_notes from survey.json when present
- Engineer agent checks survey_metadata.status for 'partial' indicator
- DIAGNOSIS.md template has "Handoff Context" section
- Integration tests verify handoff consumption works
- Phase 14 verification truth "Engineer mode receives full context" now passes
</success_criteria>

<output>
After completion, create `.planning/phases/14-survey-integration/14-04-SUMMARY.md`
</output>
