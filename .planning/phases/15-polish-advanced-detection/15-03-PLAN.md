---
phase: 15-polish-advanced-detection
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - templates/agents/banneker-surveyor.md
  - templates/config/cliff-detection-signals.md
autonomous: true

must_haves:
  truths:
    - "Surveyor uses compound detection for implicit signals"
    - "Recent response history is tracked in survey state"
    - "Implicit signals are logged to cliff_signals array in survey.json"
    - "Compound trigger offers mode switch with MEDIUM confidence indicator"
  artifacts:
    - path: "templates/agents/banneker-surveyor.md"
      provides: "Updated surveyor with compound detection integration"
      contains: "detectCompound"
    - path: "templates/config/cliff-detection-signals.md"
      provides: "Updated config with implicit signal documentation"
      contains: "Implicit Cliff Signals"
  key_links:
    - from: "templates/agents/banneker-surveyor.md"
      to: "lib/cliff-detection.js"
      via: "imports and uses detectCompound function"
      pattern: "detectCompound"
    - from: "survey-state.md"
      to: "recentHistory"
      via: "tracks implicit signals for compound detection"
      pattern: "recentHistory"
---

<objective>
Integrate compound detection into the surveyor agent to detect implicit cliff signals during surveys.

Purpose: Enable the surveyor to detect subtle uncertainty signals accumulated across responses, triggering mode switch offers when 2+ implicit signals are detected while maintaining the existing explicit signal immediate trigger behavior.

Output: Updated banneker-surveyor.md with compound detection integration and survey-state.md history tracking, plus updated cliff-detection-signals.md config documentation.
</objective>

<execution_context>
@/home/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/home/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-polish-advanced-detection/15-RESEARCH.md
@.planning/phases/15-polish-advanced-detection/15-01-SUMMARY.md

# Existing files to modify
@templates/agents/banneker-surveyor.md
@templates/config/cliff-detection-signals.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Cliff Detection Signals Config</name>
  <files>templates/config/cliff-detection-signals.md</files>
  <action>
Update the cliff-detection-signals.md config to document implicit signal patterns.

**Add new section after existing explicit signals:**

```markdown
## Implicit Cliff Signals (MEDIUM Confidence)

Implicit signals indicate uncertainty without explicit declaration. These signals use **compound detection** - requiring 2+ signals across the current response and last 3 responses before triggering a mode switch offer.

### Hedging Language
- "maybe", "perhaps", "possibly"
- "i guess", "i think maybe"
- "not sure if", "could be", "might be"
- "probably", "i suppose"

### Quality Degradation Markers
- "um", "uh", "hmm"
- "well...", "let me think"
- "that's a good question"
- "honestly i'm not"

### Soft Deferrals
- "i'll figure it out later"
- "we can decide later"
- "whatever works", "whatever is easier"
- "any of those", "you pick"
- "dealer's choice"

## Detection Rules

### Explicit Signals (HIGH Confidence)
- **Trigger:** Single match triggers mode switch offer immediately
- **Confidence:** HIGH
- **Example:** "I don't know what database to use" -> immediate offer

### Implicit Signals (MEDIUM Confidence)
- **Trigger:** 2+ signals required across current + last 3 responses
- **Confidence:** MEDIUM
- **History window:** Last 3 responses only (resets at phase boundaries)
- **Example:** "Maybe PostgreSQL" (1 signal) + later "I guess that works" (2 signals) -> compound trigger

### Logging
- All detections logged to `cliff_signals` array in survey.json
- Includes: timestamp, signal, category (explicit/hedging/quality_degradation/deferral), confidence
- Logged regardless of whether threshold met (for analytics)

### State Tracking
Survey state file tracks recent history for compound detection:

```markdown
## Cliff Detection State

**Recent Response History (for compound detection):**

| Response # | Implicit Signals | Categories |
|------------|------------------|------------|
| -3         | 0                | -          |
| -2         | 1                | hedging    |
| -1         | 1                | deferral   |
| Current    | 1                | hedging    |

**Compound signal count:** 3 (threshold: 2)
**Compound trigger:** YES
```
```
  </action>
  <verify>grep "Implicit Cliff Signals" templates/config/cliff-detection-signals.md returns match</verify>
  <done>Config file documents implicit signals, compound detection rules, and state tracking format</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Compound Detection into Surveyor</name>
  <files>templates/agents/banneker-surveyor.md</files>
  <action>
Update the surveyor agent to use compound detection for cliff signals.

**1. Update the cliff detection section in the surveyor protocol:**

Find the section that handles cliff detection (after each user response) and modify it to use compound detection:

```markdown
### Cliff Detection Protocol

After receiving each user response, check for cliff signals using compound detection.

**Step 1: Update response history**

Track recent responses for compound detection. The history is stored in survey-state.md:

```javascript
// In survey-state.md, maintain recentHistory array
const recentHistory = state.recentHistory || [];

// After processing user response, add to history
const implicitResult = detectImplicitCliff(userResponse);
recentHistory.push({
  responseNumber: state.currentResponseNumber,
  implicitSignals: implicitResult.signals,
  timestamp: new Date().toISOString()
});

// Keep only last 5 entries (we only use last 3, but buffer for safety)
if (recentHistory.length > 5) {
  recentHistory.shift();
}

state.recentHistory = recentHistory;
```

**Step 2: Run compound detection**

```javascript
// Use detectCompound with history for accumulated signal detection
const cliffResult = detectCompound(userResponse, state.recentHistory);

if (cliffResult.trigger) {
  // Log to cliff_signals array
  survey.cliff_signals = survey.cliff_signals || [];
  survey.cliff_signals.push({
    timestamp: new Date().toISOString(),
    phase: currentPhase,
    signal: cliffResult.signal || cliffResult.signals[0]?.signal,
    category: cliffResult.reason === 'explicit_signal' ? 'explicit' : cliffResult.signals[0]?.category,
    confidence: cliffResult.confidence,
    trigger_reason: cliffResult.reason,
    signal_count: cliffResult.signalCount
  });

  // Check if we should offer mode switch
  if (!state.pendingOffer && state.declinedOffers < 2) {
    // Trigger mode switch offer at phase boundary
    state.pendingOffer = true;
    state.pendingOfferConfidence = cliffResult.confidence;
    state.pendingOfferReason = cliffResult.reason;
  }
}
```

**Step 3: Log implicit signals even when not triggering**

```javascript
// Always log implicit signals for analytics, even if no trigger
if (implicitResult.detected && !cliffResult.trigger) {
  survey.cliff_signals = survey.cliff_signals || [];
  survey.cliff_signals.push({
    timestamp: new Date().toISOString(),
    phase: currentPhase,
    signals: implicitResult.signals,
    category: 'implicit_logged',
    confidence: 'MEDIUM',
    trigger_reason: 'below_threshold',
    signal_count: cliffResult.signalCount,
    threshold: 2
  });
}
```
```

**2. Update the mode switch offer to show confidence:**

Find the section that presents the mode switch offer and update it to include confidence indicator:

```markdown
### Mode Switch Offer (at phase boundary)

When `state.pendingOffer` is true and reaching a phase boundary:

**For HIGH confidence (explicit signal):**
```
I noticed you mentioned "[signal text]" - it sounds like you've reached
the limit of what you're certain about in this area.

Would you like to:
1. **Switch to Engineer Mode** - I'll analyze what we have and generate recommendations
2. **Continue Survey** - We can keep exploring, skip tough questions
3. **Skip This Topic** - Mark it for later and move on

Your choice?
```

**For MEDIUM confidence (compound implicit signals):**
```
Based on our conversation, I'm sensing some uncertainty in your responses
about this area (detected [signal_count] uncertainty indicators).

This is a softer signal than an explicit "I don't know" - so I want to
check in: Would you like to:
1. **Switch to Engineer Mode** - I'll work with what we have so far
2. **Continue Survey** - You're actually doing fine, let's keep going
3. **Skip This Topic** - Defer to engineer for these questions

Your choice?
```

Store `state.pendingOfferConfidence` to determine which message format to use.
```

**3. Update survey-state.md structure section:**

Find the survey-state.md template/structure section and add the recentHistory field:

```markdown
### Survey State Structure

```markdown
---
command: survey
status: in-progress
current_phase: 3
---

## Progress
...

## Cliff Detection State

**Pending offer:** false
**Declined offers:** 0
**Suppression threshold:** 2

### Recent Response History

Tracks last 5 responses for compound detection (only last 3 used for threshold):

| # | Phase | Implicit Signals | Categories |
|---|-------|------------------|------------|
| 1 | 2     | 0                | -          |
| 2 | 2     | 1                | hedging    |
| 3 | 3     | 0                | -          |
| 4 | 3     | 1                | deferral   |
| 5 | 3     | 1                | hedging    |

**Total implicit (last 3):** 2
**Compound threshold met:** YES

### Cliff Signals Detected

- [timestamp] Phase 2: Implicit "maybe" (hedging) - below threshold (1/2)
- [timestamp] Phase 3: Implicit "whatever works" (deferral) - below threshold (2/2)
- [timestamp] Phase 3: Implicit "i guess" (hedging) - **COMPOUND TRIGGER** (3 signals)
```
```

**4. Reset history at phase boundaries:**

Add note about resetting history at phase boundaries to keep detection contextual:

```markdown
### Phase Boundary Handling

When transitioning between phases:

1. Check for pending mode switch offer (present if triggered)
2. Reset recentHistory array (compound detection is per-phase contextual)
3. Continue with next phase questions

```javascript
// At phase transition
state.recentHistory = [];  // Reset for new phase context
```
```
  </action>
  <verify>grep -c "detectCompound" templates/agents/banneker-surveyor.md returns at least 2 matches</verify>
  <done>Surveyor integrates compound detection with history tracking, logs all signals, and shows appropriate confidence-based offer messages</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Verify config has implicit signals section:
   ```bash
   grep -A 5 "Implicit Cliff Signals" templates/config/cliff-detection-signals.md
   ```
   Expected: Shows hedging language section

2. Verify surveyor has compound detection:
   ```bash
   grep "detectCompound" templates/agents/banneker-surveyor.md
   ```
   Expected: Multiple matches for detection usage

3. Verify recentHistory tracking documented:
   ```bash
   grep "recentHistory" templates/agents/banneker-surveyor.md
   ```
   Expected: Matches for history array tracking

4. Verify confidence-based offer messages:
   ```bash
   grep "MEDIUM confidence" templates/agents/banneker-surveyor.md
   ```
   Expected: Match for compound implicit offer format
</verification>

<success_criteria>
- [ ] cliff-detection-signals.md documents implicit signals and compound rules
- [ ] Surveyor uses detectCompound() for all cliff detection
- [ ] recentHistory array tracks last 5 responses (uses last 3)
- [ ] All implicit signals logged to cliff_signals regardless of trigger
- [ ] Mode switch offer shows different message for HIGH vs MEDIUM confidence
- [ ] History resets at phase boundaries
- [ ] Existing explicit detection behavior preserved (immediate trigger)
</success_criteria>

<output>
After completion, create `.planning/phases/15-polish-advanced-detection/15-03-SUMMARY.md`
</output>
